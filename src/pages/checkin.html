<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Stitch Design</title>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Newsreader%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" onload="this.rel='stylesheet'" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
<script src="../config/config.js"></script>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<style type="text/tailwindcss">
        :root {
            --primary-color: #1791cf;
            --secondary-color: #f0f3f4;
            --text-color: #111518;
            --background-color: #f3e9d8;
            --accent-color: #e0f7fa;
            --subtle-border: #e0e0e0;
        }
        body {
            font-family: 'Newsreader', 'Noto Sans', sans-serif;
        }
        .form-input {
            background-color: white;
            border: 1px solid var(--subtle-border);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            transition: all 0.2s ease-in-out;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(23, 145, 207, 0.1);
        }
        .form-input:disabled {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }
        .checkbox-custom {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid var(--subtle-border);
            border-radius: 0.375rem;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease-in-out;
        }
        .checkbox-custom:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .checkbox-custom:checked::after {
            content: "âœ”";
            color: white;
            font-size: 0.8rem;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-primary:hover {
            background-color: #147ab3;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .magic-wand-icon {
            font-family: 'Material Symbols Outlined';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
        }
    </style>
</head>
<body class="bg-[var(--background-color)]">
<div class="relative flex size-full min-h-screen flex-col group/design-root overflow-x-hidden">
<div class="layout-container flex h-full grow flex-col">
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-[var(--subtle-border)] bg-white px-10 py-4 shadow-sm">
<div class="flex items-center gap-3 text-[var(--text-color)]">
<span class="material-symbols-outlined text-3xl text-[var(--primary-color)]">auto_stories</span>
<h1 class="text-xl font-bold leading-tight tracking-[-0.015em]">Enchanted Check-In</h1>
</div>
<div class="flex flex-1 justify-end gap-6">
<nav class="flex items-center gap-8">
<a class="text-sm font-medium text-[var(--text-color)] hover:text-[var(--primary-color)] transition-colors" href="#">Dashboard</a>
<a class="text-sm font-medium text-[var(--text-color)] hover:text-[var(--primary-color)] transition-colors" href="#">Guests</a>
<a class="text-sm font-medium text-[var(--text-color)] hover:text-[var(--primary-color)] transition-colors" href="#">Tables</a>
<a class="text-sm font-medium text-[var(--text-color)] hover:text-[var(--primary-color)] transition-colors" href="#">Gifts</a>
</nav>
<div class="flex items-center gap-4">
<button class="flex size-10 cursor-pointer items-center justify-center rounded-full bg-[var(--secondary-color)] text-[var(--text-color)] transition-colors hover:bg-gray-200">
<span class="material-symbols-outlined">notifications</span>
</button>
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 border-2 border-white shadow-md" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAzoLzGX5LzjT3jrnVLh1olWlJv05hkIF-_4qpqB7r3vt_6DxQoFKqlER0FwQC8_ovDJtJbJNrZKOnh1hSVs9rwgpEToPlx8yQDXhBy17Fc1d-_dRUvIy-CidFexPgY3FqRWoR3TCzU1oV7tMiWTH625DSiyPEc8dJhUu3q22m088UVWfE_haSPGhm5-fsXAEZ-bX5n2WAEFT8WFsOtMsZFRTQiR7v199fv3ph7Is0BX9mm05BO0wDLmkKqMKlWATVFEsluPKaILAk");'></div>
</div>
</div>
</header>
<main class="flex flex-1 justify-center py-12">
<div class="w-full max-w-2xl px-4">
<div class="bg-white p-8 sm:p-12 rounded-2xl shadow-lg border border-[var(--subtle-border)]">
<div class="text-center mb-10 relative">
<button onclick="goBack()" class="absolute left-0 top-0 flex items-center gap-2 text-sm font-medium text-[var(--primary-color)] hover:text-blue-700 transition-colors">
<span class="material-symbols-outlined text-lg">arrow_back</span>
å›åˆ°è³“å®¢æ¸…å–®
</button>
<h2 class="text-3xl font-bold text-[var(--text-color)] tracking-tight">Guest Check-In</h2>
<p class="mt-2 text-base text-gray-500">Welcome to a magical celebration!</p>
</div>
<form class="space-y-6">
<div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
<div>
<label class="block text-sm font-medium leading-6 text-[var(--text-color)]" for="serial-number">System Serial Number</label>
<div class="mt-2">
<input class="form-input w-full" id="serial-number" name="serial-number" placeholder="e.g., 934" type="text"/>
</div>
</div>
<div>
<label class="block text-sm font-medium leading-6 text-[var(--text-color)]" for="guest-name">Guest Name</label>
<div class="mt-2">
<input class="form-input w-full" id="guest-name" name="guest-name" placeholder="e.g., Luna Lovegood" type="text"/>
</div>
</div>
</div>

<!-- å®¶åº­æˆå“¡é¡¯ç¤ºå€åŸŸ -->
<div id="family-info-section" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4">
    <h3 class="text-lg font-semibold text-blue-800 mb-3 flex items-center">
        <span class="material-symbols-outlined mr-2">family_restroom</span>
        å®¶åº­æˆå“¡æ¸…å–®
    </h3>
    <p class="text-sm text-blue-600 mb-3">
        âš¡ <strong>ä¸€äººå ±åˆ° = å…¨å®¶å ±åˆ°</strong> - æ­¤è³“å®¢å ±åˆ°å¾Œï¼Œä»¥ä¸‹å®¶åº­æˆå“¡å°‡åŒæ™‚å®Œæˆå ±åˆ°
    </p>
    <div id="family-members-list" class="space-y-2">
        <!-- å®¶åº­æˆå“¡å°‡å‹•æ…‹è¼‰å…¥åˆ°é€™è£¡ -->
    </div>
    <div class="mt-4 pt-4 border-t border-blue-200">
        <div class="flex justify-between items-center">
            <span class="text-sm font-medium text-blue-800">å¿«é€Ÿå®¶åº­å ±åˆ°</span>
            <button id="family-checkin-btn" type="button" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors">
                <span class="material-symbols-outlined text-lg">group</span>
                å…¨å®¶å ±åˆ°
            </button>
        </div>
        <p class="text-xs text-blue-600 mt-1">é»æ“Šã€Œå…¨å®¶å ±åˆ°ã€å¯ä¸€æ¬¡å®Œæˆæ‰€æœ‰å®¶åº­æˆå“¡çš„å ±åˆ°</p>
    </div>
</div>
<div class="space-y-4 pt-4 border-t border-gray-200">
<div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
<div class="relative flex items-start">
<div class="flex h-6 items-center">
<input class="checkbox-custom" id="collect-money" name="collect-money" type="checkbox"/>
</div>
<div class="ml-3 text-sm leading-6">
<label class="font-medium text-[var(--text-color)] cursor-pointer" for="collect-money">Collect Gift Money</label>
</div>
</div>
<div class="relative flex items-start">
<div class="flex h-6 items-center">
<input class="checkbox-custom" id="has-cake" name="has-cake" type="checkbox"/>
</div>
<div class="ml-3 text-sm leading-6">
<label class="font-medium text-[var(--text-color)] cursor-pointer" for="has-cake">Has Wedding Cake</label>
</div>
</div>
</div>
</div>
<div class="grid grid-cols-1 sm:grid-cols-2 gap-6 items-end">
<div id="gift-amount-section">
<label class="block text-sm font-medium leading-6 text-[var(--text-color)]" for="gift-amount">Amount of Gift Money Collected</label>
<div class="relative mt-2 rounded-md shadow-sm">
<div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
<span class="text-gray-500 sm:text-sm"></span>
</div>
<input class="form-input block w-full pl-20" disabled="" id="gift-amount" name="gift-amount" placeholder="0.00" type="number"/>
</div>
</div>
<div class="relative flex items-start" id="cake-given-section">
<div class="flex h-6 items-center">
<input class="checkbox-custom" id="cake-given" name="cake-given" type="checkbox"/>
</div>
<div class="ml-3 text-sm leading-6">
<label class="font-medium text-[var(--text-color)] cursor-pointer" for="cake-given">Wedding Cake Given</label>
</div>
</div>
</div>
<!-- å‚™è¨»æ¬„ä½ -->
<div class="mt-6">
<label class="block text-sm font-medium leading-6 text-[var(--text-color)]" for="remarks">å‚™è¨» (Notes)</label>
<div class="mt-2">
<textarea class="form-input w-full resize-none" id="remarks" name="remarks" placeholder="ç‰¹æ®Šéœ€æ±‚ã€è™•ç†ç‹€æ…‹ç­‰å‚™è¨»..." rows="3"></textarea>
</div>
</div>
<!-- å®¶åº­æˆå“¡æ¸…å–®ï¼ˆåœ¨check-inæŒ‰éˆ•ä¸Šæ–¹ï¼‰ -->
<div id="family-members-summary" class="hidden mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
    <div class="flex items-center mb-3">
        <span class="material-symbols-outlined text-blue-600 mr-2">group</span>
        <h4 class="text-sm font-semibold text-blue-800">åŒä¸€å®¶åº­æˆå“¡</h4>
    </div>
    <div id="family-members-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
        <!-- å®¶åº­æˆå“¡å°‡å‹•æ…‹è¼‰å…¥åˆ°é€™è£¡ -->
    </div>
    <p class="text-xs text-blue-600 mt-2">ğŸ’¡ æ­¤è³“å®¢å ±åˆ°å¾Œï¼Œæ‰€æœ‰å®¶åº­æˆå“¡å°‡åŒæ™‚å®Œæˆå ±åˆ°</p>
</div>

<div class="pt-6 text-center">
<button class="btn-primary inline-flex items-center gap-2" type="submit">
<span class="magic-wand-icon text-lg">auto_fix_high</span> Check-in Successful
                            </button>
</div>
</form>
</div>
</div>
</main>
</div>
</div>
<script>
    // Google Apps Script URL å¾é…ç½®æ–‡ä»¶è¼‰å…¥
    const GOOGLE_SCRIPT_URL = window.CONFIG?.GOOGLE_SCRIPT_URL || alert('è«‹å…ˆè¨­å®š config.js é…ç½®æ–‡ä»¶ï¼');

    // å›åˆ°è³“å®¢æ¸…å–®é é¢
    function goBack() {
        // æ·»åŠ æ™‚é–“æˆ³ç¢ºä¿é é¢é‡æ–°è¼‰å…¥ä¸¦åˆ·æ–°è³‡æ–™
        window.location.href = 'guestlist.html?refresh=' + Date.now();
    }

    document.addEventListener('DOMContentLoaded', function() {
        // è™•ç† URL åƒæ•¸ï¼Œé å¡«è³“å®¢è³‡è¨Š
        const urlParams = new URLSearchParams(window.location.search);
        const serialNumber = urlParams.get('sn');
        const guestName = urlParams.get('name');
        const collectMoney = urlParams.get('collectMoney') === 'true';
        const hasCake = urlParams.get('hasCake') === 'true';
        const familyId = urlParams.get('familyId');
        const familyMembersJson = urlParams.get('familyMembers');

        if (serialNumber) {
            document.getElementById('serial-number').value = serialNumber;
        }
        if (guestName) {
            document.getElementById('guest-name').value = decodeURIComponent(guestName);

            // é™¤éŒ¯ï¼šé¡¯ç¤ºæ‰€æœ‰æ¥æ”¶åˆ°çš„åƒæ•¸
            console.log('ğŸ“‹ å ±åˆ°ç•«é¢æ¥æ”¶åˆ°çš„ URL åƒæ•¸:', {
                serialNumber: serialNumber,
                guestName: guestName ? decodeURIComponent(guestName) : null,
                collectMoney: collectMoney,
                hasCake: hasCake,
                familyId: familyId,
                familyMembersJson: familyMembersJson ? 'æœ‰è³‡æ–™' : 'ç„¡è³‡æ–™',
                allParams: Object.fromEntries(urlParams.entries())
            });

            // å¦‚æœæœ‰å®¶åº­æˆå“¡è³‡è¨Šï¼Œç›´æ¥é¡¯ç¤ºï¼Œä¸éœ€è¦å†ç™¼è«‹æ±‚
            if (familyId && familyMembersJson) {
                try {
                    const familyMembers = JSON.parse(decodeURIComponent(familyMembersJson));
                    console.log('âœ… æˆåŠŸè§£æå®¶åº­æˆå“¡è³‡è¨Š:', familyMembers);
                    displayFamilyMembersFromURL(familyMembers);
                } catch (error) {
                    console.log('âŒ è§£æå®¶åº­æˆå“¡è³‡è¨Šå¤±æ•—:', error);
                }
            } else {
                console.log('â„¹ï¸  ç„¡å®¶åº­æˆå“¡è³‡è¨Š - familyId:', familyId, 'familyMembersJson:', familyMembersJson);
            }
        }
        if (collectMoney) {
            document.getElementById('collect-money').checked = true;
        }
        if (hasCake) {
            document.getElementById('has-cake').checked = true;
        }

        const collectMoneyCheckbox = document.getElementById('collect-money');
        const giftAmountInput = document.getElementById('gift-amount');
        const giftAmountSection = document.getElementById('gift-amount-section');
        const form = document.querySelector('form');

        function toggleGiftAmount() {
            if (collectMoneyCheckbox.checked) {
                giftAmountInput.disabled = false;
                giftAmountSection.classList.remove('opacity-50');
            } else {
                giftAmountInput.disabled = true;
                giftAmountInput.value = '';
                giftAmountSection.classList.add('opacity-50');
            }
        }

        collectMoneyCheckbox.addEventListener('change', toggleGiftAmount);

        // è¡¨å–®æäº¤è™•ç†
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const button = form.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="magic-wand-icon text-lg">hourglass_top</span> æäº¤ä¸­...';
            button.disabled = true;

            try {
                const formData = new FormData(form);
                const data = {
                    serialNumber: formData.get('serial-number'),
                    guestName: formData.get('guest-name'),
                    collectMoney: formData.get('collect-money') === 'on',
                    giftAmount: parseInt(formData.get('gift-amount')) || 0,
                    hasCake: formData.get('has-cake') === 'on',
                    cakeGiven: formData.get('cake-given') === 'on',
                    remarks: formData.get('remarks') || ''
                };

                // èª¿è©¦ï¼šé¡¯ç¤ºè¦å‚³é€çš„è³‡æ–™
                console.log('æº–å‚™å‚³é€çš„è³‡æ–™:', data);
                console.log('è¡¨å–®åŸå§‹è³‡æ–™:', {
                    'serial-number': formData.get('serial-number'),
                    'guest-name': formData.get('guest-name'),
                    'collect-money': formData.get('collect-money'),
                    'gift-amount': formData.get('gift-amount'),
                    'has-cake': formData.get('has-cake'),
                    'cake-given': formData.get('cake-given')
                });

                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                // no-cors æ¨¡å¼ç„¡æ³•è®€å–å›æ‡‰ï¼Œå‡è¨­æäº¤æˆåŠŸ
                console.log('è³‡æ–™å·²æäº¤ (no-cors æ¨¡å¼)');

                // æˆåŠŸæç¤º
                button.innerHTML = '<span class="magic-wand-icon text-lg">check_circle</span> ç°½åˆ°æˆåŠŸï¼';
                button.style.backgroundColor = '#22c55e';

                // 2ç§’å¾Œè‡ªå‹•è·³è½‰å›è³“å®¢æ¸…å–®ï¼Œå‚³éå ±åˆ°è³‡è¨Šç”¨æ–¼æœ¬åœ°æ›´æ–°
                setTimeout(() => {
                    const checkInParams = new URLSearchParams({
                        refresh: Date.now(),
                        localUpdate: 'true',
                        sn: data.serialNumber,
                        name: encodeURIComponent(data.guestName),
                        collectMoney: data.collectMoney || false,
                        giftAmount: data.giftAmount || 0,
                        hasCake: data.hasCake || false,
                        cakeGiven: data.cakeGiven || false
                    });
                    window.location.href = `guestlist.html?${checkInParams.toString()}`;
                }, 2000);

            } catch (error) {
                console.error('Error:', error);
                button.innerHTML = '<span class="magic-wand-icon text-lg">error</span> æäº¤å¤±æ•—ï¼Œè«‹é‡è©¦';
                button.style.backgroundColor = '#ef4444';

                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.backgroundColor = 'var(--primary-color)';
                    button.disabled = false;
                }, 3000);
            }
        });

        // Initial state
        toggleGiftAmount();
    });

    // ç°¡å–®æŸ¥è©¢å®¶åº­æˆå“¡ä¸¦åœ¨check-inæŒ‰éˆ•ä¸Šæ–¹é¡¯ç¤º (ä½¿ç”¨JSONP)
    function loadFamilyMembersSimple(guestName) {
        if (!guestName || guestName.trim() === '') {
            hideFamilyMembersSimple();
            return;
        }

        // æ¸…ç†ä¹‹å‰çš„ JSONP script æ¨™ç±¤
        const oldScript = document.querySelector('script[data-jsonp="family-info"]');
        if (oldScript) {
            oldScript.remove();
        }

        // è¨­å®šå…¨åŸŸå›èª¿å‡½æ•¸
        window.handleFamilyInfo = function(response) {
            console.log('å®¶åº­è³‡è¨Š JSONP å›æ‡‰:', response);

            if (response.hasFamilyInfo && response.familyMembers && response.familyMembers.length > 1) {
                displayFamilyMembersSimple(response.familyMembers);
            } else {
                hideFamilyMembersSimple();
            }
        };

        // å‰µå»º JSONP script æ¨™ç±¤
        const script = document.createElement('script');
        script.setAttribute('data-jsonp', 'family-info');

        const params = new URLSearchParams({
            action: 'getFamilyInfo',
            guestName: guestName,
            callback: 'handleFamilyInfo',
            _t: Date.now()
        });

        script.src = `${GOOGLE_SCRIPT_URL}?${params.toString()}`;

        // éŒ¯èª¤è™•ç†
        script.onerror = function() {
            console.log('JSONP å®¶åº­è³‡è¨ŠæŸ¥è©¢å¤±æ•—');
            hideFamilyMembersSimple();
        };

        // æ·»åŠ åˆ°é é¢
        document.head.appendChild(script);

        console.log('ç™¼é€å®¶åº­è³‡è¨Š JSONP è«‹æ±‚:', script.src);
    }

    // ç›´æ¥å¾ URL åƒæ•¸é¡¯ç¤ºå®¶åº­æˆå“¡ï¼ˆç„¡éœ€ç¶²è·¯è«‹æ±‚ï¼‰
    function displayFamilyMembersFromURL(familyMembers) {
        const summarySection = document.getElementById('family-members-summary');
        const membersGrid = document.getElementById('family-members-grid');

        if (!familyMembers || familyMembers.length <= 1) {
            hideFamilyMembersSimple();
            return;
        }

        // ç”Ÿæˆå®¶åº­æˆå“¡ç¶²æ ¼
        membersGrid.innerHTML = familyMembers.map(member => `
            <div class="flex items-center space-x-2 text-sm">
                <span class="material-symbols-outlined text-blue-600" style="font-size: 16px;">person</span>
                <span class="text-gray-700">${member.memberName}</span>
                <span class="ml-auto ${member.isCheckedIn ? 'text-green-600' : 'text-gray-400'} text-xs">
                    ${member.isCheckedIn ? 'âœ“' : 'â—‹'}
                </span>
            </div>
        `).join('');

        // é¡¯ç¤ºå®¶åº­è³‡è¨Šå€åŸŸ
        summarySection.classList.remove('hidden');
        console.log('å®¶åº­æˆå“¡è³‡è¨Šå·²å¾ URL åƒæ•¸ç›´æ¥è¼‰å…¥ï¼Œç„¡éœ€é¡å¤–è«‹æ±‚');
    }

    // åœ¨check-inæŒ‰éˆ•ä¸Šæ–¹é¡¯ç¤ºå®¶åº­æˆå“¡ï¼ˆJSONP ç‰ˆæœ¬ - ä¿ç•™å‚™ç”¨ï¼‰
    function displayFamilyMembersSimple(familyMembers) {
        displayFamilyMembersFromURL(familyMembers);
    }

    // éš±è—å®¶åº­æˆå“¡ç°¡å–®æ¸…å–®
    function hideFamilyMembersSimple() {
        const summarySection = document.getElementById('family-members-summary');
        summarySection.classList.add('hidden');
    }

    // æŸ¥è©¢å®¶åº­æˆå“¡è³‡è¨Šï¼ˆç°¡åŒ–ç‰ˆï¼‰
    async function loadFamilyInfo(guestName) {
        if (!guestName || guestName.trim() === '') return;

        try {
            // èª¿ç”¨ Google Apps Script æŸ¥è©¢å®¶åº­è³‡è¨Š
            const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getFamilyInfo&guestName=${encodeURIComponent(guestName)}`, {
                method: 'GET',
                mode: 'cors'
            });

            if (!response.ok) {
                console.log('ç„¡æ³•æŸ¥è©¢å®¶åº­è³‡è¨Š');
                hideFamilyInfo();
                return;
            }

            const familyInfo = await response.json();

            if (familyInfo.hasFamilyInfo && familyInfo.familyMembers && familyInfo.familyMembers.length > 1) {
                displayFamilyMembers(familyInfo.familyMembers);
            } else {
                hideFamilyInfo();
            }

        } catch (error) {
            console.log('æŸ¥è©¢å®¶åº­è³‡è¨Šå¤±æ•—:', error);
            hideFamilyInfo();
        }
    }

    // é¡¯ç¤ºå®¶åº­æˆå“¡æ¸…å–®
    function displayFamilyMembers(familyMembers) {
        const familySection = document.getElementById('family-info-section');
        const membersList = document.getElementById('family-members-list');
        const familyCheckinBtn = document.getElementById('family-checkin-btn');

        if (!familyMembers || familyMembers.length === 0) {
            hideFamilyInfo();
            return;
        }

        // å„²å­˜å®¶åº­æˆå“¡è³‡æ–™ä¾›å¿«é€Ÿå ±åˆ°ä½¿ç”¨
        window.currentFamilyMembers = familyMembers;

        // ç”Ÿæˆå®¶åº­æˆå“¡æ¸…å–®HTMLï¼ˆç°¡åŒ–ç‰ˆï¼‰
        membersList.innerHTML = familyMembers.map(member => `
            <div class="flex items-center justify-between bg-white p-3 rounded border">
                <div class="flex items-center space-x-3">
                    <span class="material-symbols-outlined text-blue-600">person</span>
                    <div>
                        <div class="font-medium text-gray-900">${member.memberName}</div>
                        <div class="text-sm text-gray-500">å®¶åº­æˆå“¡</div>
                    </div>
                </div>
                <div class="text-sm">
                    ${member.isCheckedIn ?
                        '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full">å·²å ±åˆ°</span>' :
                        '<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded-full">æœªå ±åˆ°</span>'
                    }
                </div>
            </div>
        `).join('');

        // æª¢æŸ¥æ˜¯å¦æœ‰æœªå ±åˆ°çš„æˆå“¡
        const hasUncheckedMembers = familyMembers.some(member => !member.isCheckedIn);

        if (hasUncheckedMembers) {
            familyCheckinBtn.disabled = false;
            familyCheckinBtn.innerHTML = '<span class="material-symbols-outlined text-lg">group</span> å…¨å®¶å ±åˆ°';
            familyCheckinBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors';
        } else {
            familyCheckinBtn.disabled = true;
            familyCheckinBtn.innerHTML = '<span class="material-symbols-outlined text-lg">check_circle</span> å…¨å®¶å·²å ±åˆ°';
            familyCheckinBtn.className = 'bg-gray-400 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 cursor-not-allowed';
        }

        // é¡¯ç¤ºå®¶åº­è³‡è¨Šå€åŸŸ
        familySection.classList.remove('hidden');
    }

    // éš±è—å®¶åº­è³‡è¨Š
    function hideFamilyInfo() {
        const familySection = document.getElementById('family-info-section');
        familySection.classList.add('hidden');
    }

    // å¿«é€Ÿå®¶åº­å ±åˆ°åŠŸèƒ½
    async function processFamilyCheckIn() {
        if (!window.currentFamilyMembers) {
            alert('æ²’æœ‰å®¶åº­æˆå“¡è³‡è¨Š');
            return;
        }

        const familyCheckinBtn = document.getElementById('family-checkin-btn');
        const originalText = familyCheckinBtn.innerHTML;

        // å–å¾—è¡¨å–®è³‡æ–™
        const formData = new FormData(document.querySelector('form'));
        const data = {
            guestName: formData.get('guest-name'),
            serialNumber: formData.get('serial-number'),
            collectMoney: formData.get('collect-money') === 'on',
            giftAmount: parseInt(formData.get('gift-amount')) || 0,
            hasCake: formData.get('has-cake') === 'on',
            cakeGiven: formData.get('cake-given') === 'on',
            remarks: formData.get('remarks') || ''
        };

        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        familyCheckinBtn.innerHTML = '<span class="material-symbols-outlined text-lg animate-spin">hourglass_top</span> è™•ç†ä¸­...';
        familyCheckinBtn.disabled = true;

        try {
            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            // æˆåŠŸæç¤º
            familyCheckinBtn.innerHTML = '<span class="material-symbols-outlined text-lg">check_circle</span> å…¨å®¶å ±åˆ°æˆåŠŸï¼';
            familyCheckinBtn.className = 'bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2';

            // 2ç§’å¾Œè·³è½‰å›è³“å®¢æ¸…å–®
            setTimeout(() => {
                window.location.href = 'guestlist.html?refresh=' + Date.now();
            }, 2000);

        } catch (error) {
            console.error('å¿«é€Ÿå®¶åº­å ±åˆ°å¤±æ•—:', error);
            familyCheckinBtn.innerHTML = '<span class="material-symbols-outlined text-lg">error</span> å ±åˆ°å¤±æ•—';
            familyCheckinBtn.className = 'bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2';

            // 3ç§’å¾Œæ¢å¾©åŸç‹€æ…‹
            setTimeout(() => {
                familyCheckinBtn.innerHTML = originalText;
                familyCheckinBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors';
                familyCheckinBtn.disabled = false;
            }, 3000);
        }
    }

    // æ·»åŠ äº‹ä»¶ç›£è½å™¨
    document.addEventListener('DOMContentLoaded', function() {
        const guestNameInput = document.getElementById('guest-name');
        const familyCheckinBtn = document.getElementById('family-checkin-btn');
        let inputTimer;

        // è³“å®¢å§“åè¼¸å…¥ç›£è½å™¨ï¼ˆå·²å„ªåŒ–ï¼šå®¶åº­è³‡è¨Šå¾ URL ç›´æ¥è¼‰å…¥ï¼Œä¸éœ€è¦å³æ™‚æŸ¥è©¢ï¼‰
        // guestNameInput.addEventListener('input', function() {
        //     const guestName = this.value.trim();
        //
        //     // æ¸…é™¤ä¹‹å‰çš„è¨ˆæ™‚å™¨
        //     clearTimeout(inputTimer);
        //
        //     // 500ms å¾ŒåŸ·è¡ŒæŸ¥è©¢ï¼ˆé˜²æ­¢é »ç¹æŸ¥è©¢ï¼‰
        //     inputTimer = setTimeout(() => {
        //         if (guestName) {
        //             loadFamilyMembersSimple(guestName);
        //         } else {
        //             hideFamilyMembersSimple();
        //         }
        //     }, 500);
        // });

        // å¿«é€Ÿå®¶åº­å ±åˆ°æŒ‰éˆ•ç›£è½å™¨
        familyCheckinBtn.addEventListener('click', processFamilyCheckIn);
    });
</script>

</body></html>