<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Guest List - Enchanted Check-In</title>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Newsreader%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" onload="this.rel='stylesheet'" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
<script src="../config/config.js"></script>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<style type="text/tailwindcss">
        :root {
            --primary-color: #1791cf;
            --secondary-color: #f0f3f4;
            --text-color: #111518;
            --background-color: #f3e9d8;
            --accent-color: #e0f7fa;
            --subtle-border: #e0e0e0;
            --checked-in-bg: #e8f5e9;
            --unchecked-bg: #ffffff;
            --checked-in-text: #2e7d32;
            --unchecked-text: #111518;
        }
        body {
            font-family: 'Newsreader', 'Noto Sans', sans-serif;
        }
        .checkbox-custom {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid var(--subtle-border);
            border-radius: 0.375rem;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease-in-out;
            background-color: transparent;
        }
        .checkbox-custom:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .checkbox-custom:checked::after {
            content: "âœ”";
            color: white;
            font-size: 0.8rem;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-primary:hover {
            background-color: #147ab3;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .magic-wand-icon {
            font-family: 'Material Symbols Outlined';
            font-weight: normal;
            font-style: normal;
            font-size: 20px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
        }
        .table-header {
             color: #ffffff;
             font-weight: 700;
             padding: 1rem 1.5rem;
             text-align: left;
             font-size: 0.875rem;
             text-transform: uppercase;
             letter-spacing: 0.05em;
        }
        .table-cell {
            padding: 1rem 1.5rem;
            white-space: nowrap;
        }
        .checked-in-row {
            background-color: var(--checked-in-bg);
            color: var(--checked-in-text);
        }
         .checked-in-row .checkbox-custom {
            border-color: #a5d6a7;
        }
        .unchecked-row {
            background-color: var(--unchecked-bg);
            color: var(--unchecked-text);
        }
        .unchecked-row .checkbox-custom {
             border-color: #e0e0e0;
        }

        /* å®¶åº­ç¾¤çµ„æ¨£å¼ - ç²—æ¡†ç‰ˆæœ¬ */
        .family-group-first {
            border: none;
            border-radius: 8px 8px 0 0;
            background: rgba(23, 145, 207, 0.02);
        }

        .family-group-middle {
            border: none;
            background: rgba(23, 145, 207, 0.02);
        }

        .family-group-last {
            border: none;
            border-radius: 0 0 8px 8px;
            background: rgba(23, 145, 207, 0.02);
        }

        .family-group-single {
            border: none;
            border-radius: 8px;
            background: rgba(23, 145, 207, 0.02);
        }

        /* å®¶åº­ç¾¤çµ„å·²å ±åˆ°æ¨£å¼ - ç¶ åº•é»‘å­— */
        .family-group-first.checked-in-row {
            background-color: #e8f5e8;
            color: #000000;
            border-color: #4caf50;
        }

        .family-group-middle.checked-in-row {
            background-color: #e8f5e8;
            color: #000000;
            border-color: #4caf50;
        }

        .family-group-last.checked-in-row {
            background-color: #e8f5e8;
            color: #000000;
            border-color: #4caf50;
        }

        .family-group-single.checked-in-row {
            background-color: #e8f5e8;
            color: #000000;
            border-color: #4caf50;
        }

        /* å®¶åº­ç·¨è™Ÿæ¨™è¨˜ */
        .family-group-first .table-cell:first-child::after,
        .family-group-single .table-cell:first-child::after {
            content: "ğŸ‘ª";
            position: absolute;
            margin-left: 5px;
            font-size: 12px;
            opacity: 0.7;
        }
    </style>
</head>
<body class="bg-[var(--background-color)]">
<div class="relative flex size-full min-h-screen flex-col group/design-root overflow-x-hidden">
<div class="layout-container flex h-full grow flex-col">
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-[var(--subtle-border)] bg-white px-10 py-4 shadow-sm">
<div class="flex items-center gap-3 text-[var(--text-color)]">
<span class="material-symbols-outlined text-3xl text-[var(--primary-color)]">auto_stories</span>
<h1 class="text-xl font-bold leading-tight tracking-[-0.015em]">Enchanted Check-In</h1>
</div>
<div class="flex flex-1 justify-end gap-6">
<nav class="flex items-center gap-8">
<a class="text-sm font-medium text-[var(--text-color)] hover:text-[var(--primary-color)] transition-colors" href="#">Dashboard</a>
<a class="text-sm font-medium text-[var(--primary-color)] font-semibold" href="#">Guests</a>
<a class="text-sm font-medium text-[var(--text-color)] hover:text-[var(--primary-color)] transition-colors" href="#">Tables</a>
<a class="text-sm font-medium text-[var(--text-color)] hover:text-[var(--primary-color)] transition-colors" href="#">Gifts</a>
</nav>
<div class="flex items-center gap-4">
<button class="flex size-10 cursor-pointer items-center justify-center rounded-full bg-[var(--secondary-color)] text-[var(--text-color)] transition-colors hover:bg-gray-200">
<span class="material-symbols-outlined">notifications</span>
</button>
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 border-2 border-white shadow-md" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAzoLzGX5LzjT3jrnVLh1olWlJv05hkIF-_4qpqB7r3vt_6DxQoFKqlER0FwQC8_ovDJtJbJNrZKOnh1hSVs9rwgpEToPlx8yQDXhBy17Fc1d-_dRUvIy-CidFexPgY3FqRWoR3TCzU1oV7tMiWTH625DSiyPEc8dJhUu3q22m088UVWfE_haSPGhm5-fsXAEZ-bX5n2WAEFT8WFsOtMsZFRTQiR7v199fv3ph7Is0BX9mm05BO0wDLmkKqMKlWATVFEsluPKaILAk");'></div>
</div>
</div>
</header>
<main class="flex-1 p-6 sm:p-10">
<div class="mx-auto max-w-7xl">
<div class="flex items-center justify-between mb-8">
<h2 class="text-3xl font-bold text-[var(--text-color)] tracking-tight">Guest List</h2>
<button class="btn-primary" type="button">
<span class="material-symbols-outlined text-lg">person_add</span> Add New Guest
            </button>
</div>
<div class="bg-white rounded-2xl shadow-lg border border-[var(--subtle-border)] overflow-hidden">
<!-- æœå°‹æ¬„ä½ -->
<div class="p-6 border-b border-[var(--subtle-border)]">
<div class="relative max-w-md">
<span class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</span>
<input type="text" id="search-input" placeholder="æœå°‹ç·¨è™Ÿæˆ–å§“å..."
       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none transition-all">
<button id="clear-search" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden">
<span class="material-symbols-outlined text-lg">close</span>
</button>
</div>
</div>
<div class="overflow-x-auto">
<table class="w-full text-sm">
<thead class="bg-gray-800">
<tr>
<th class="table-header">S/N</th>
<th class="table-header">Guest Name</th>
<th class="table-header text-center">Family</th>
<th class="table-header text-center">Collect Gift Money</th>
<th class="table-header text-center">Has Wedding Cake</th>
<th class="table-header"></th>
</tr>
</thead>
<tbody id="guest-table-body" class="divide-y divide-[var(--subtle-border)]">
                            <!-- è¼‰å…¥ä¸­çš„æç¤º -->
                            <tr id="loading-row">
                                <td colspan="6" class="table-cell text-center py-8">
                                    <span class="material-symbols-outlined animate-spin text-2xl text-[var(--primary-color)]">refresh</span>
                                    <div class="mt-2 text-gray-500">è¼‰å…¥è³“å®¢è³‡æ–™ä¸­...</div>
                                </td>
                            </tr>
                        </tbody>
</table>
</div>

<!-- åˆ†é è³‡è¨Šå’Œå°èˆª -->
<div class="px-6 py-4 border-t border-[var(--subtle-border)] bg-gray-50">
<div class="flex flex-col sm:flex-row justify-between items-center gap-4">
<!-- è³‡è¨Šé¡¯ç¤º -->
<div class="text-sm text-gray-600">
<span id="pagination-info">é¡¯ç¤ºç¬¬ 1-20 ç­†ï¼Œå…± 0 ç­†è³“å®¢</span>
</div>

<!-- åˆ†é å°èˆª -->
<div class="flex items-center space-x-1">
<!-- ä¸Šä¸€é æŒ‰éˆ• -->
<button id="prev-page" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-l-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
<span class="material-symbols-outlined text-lg">chevron_left</span>
</button>

<!-- é ç¢¼æŒ‰éˆ•å®¹å™¨ -->
<div id="page-numbers" class="flex space-x-1">
<!-- é ç¢¼æŒ‰éˆ•æœƒå‹•æ…‹ç”Ÿæˆ -->
</div>

<!-- ä¸‹ä¸€é æŒ‰éˆ• -->
<button id="next-page" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-r-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
<span class="material-symbols-outlined text-lg">chevron_right</span>
</button>
</div>
</div>
</div>

</div>
</div>
</main>
</div>
</div>

<script>
    // Google Apps Script URL å¾é…ç½®æ–‡ä»¶è¼‰å…¥
    const GOOGLE_SCRIPT_READ_URL = window.CONFIG?.GOOGLE_SCRIPT_URL || (() => { alert('è«‹å…ˆè¨­å®š config.js é…ç½®æ–‡ä»¶ï¼'); return ''; })();

    let guestData = []; // å…¨éƒ¨è³“å®¢è³‡æ–™
    let filteredData = []; // æœå°‹éæ¿¾å¾Œçš„è³‡æ–™
    let currentSearchTerm = ''; // ç›®å‰çš„æœå°‹é—œéµå­—
    let lastDataUpdateTime = 0; // æœ€å¾Œè³‡æ–™æ›´æ–°æ™‚é–“

    // ğŸ—„ï¸ æŒä¹…åŒ–ç·©å­˜é…ç½®
    const CACHE_KEY = 'wedding_guest_data';
    const CACHE_TIME_KEY = 'wedding_guest_data_time';
    const CACHE_DURATION = 5 * 60 * 1000; // 5åˆ†é˜ç·©å­˜

    // åˆ†é è®Šæ•¸
    const itemsPerPage = 20;
    let currentPage = 1;

    // ğŸ—„ï¸ æŒä¹…åŒ–ç·©å­˜ç®¡ç†
    function saveCacheToStorage() {
        try {
            localStorage.setItem(CACHE_KEY, JSON.stringify(guestData));
            localStorage.setItem(CACHE_TIME_KEY, lastDataUpdateTime.toString());
        } catch (error) {
            console.warn('âš ï¸ localStorage ä¿å­˜å¤±æ•—:', error);
        }
    }

    function loadCacheFromStorage() {
        try {
            const cachedData = localStorage.getItem(CACHE_KEY);
            const cachedTime = localStorage.getItem(CACHE_TIME_KEY);

            if (cachedData && cachedTime) {
                const cacheAge = Date.now() - parseInt(cachedTime);
                if (cacheAge < CACHE_DURATION) {
                    guestData = JSON.parse(cachedData);
                    lastDataUpdateTime = parseInt(cachedTime);
                    return true;
                } else {
                    clearCacheFromStorage();
                }
            }
        } catch (error) {
            console.warn('âš ï¸ localStorage è®€å–å¤±æ•—:', error);
            clearCacheFromStorage();
        }
        return false;
    }

    function clearCacheFromStorage() {
        try {
            localStorage.removeItem(CACHE_KEY);
            localStorage.removeItem(CACHE_TIME_KEY);
        } catch (error) {
            console.warn('âš ï¸ localStorage æ¸…é™¤å¤±æ•—:', error);
        }
    }

    // ğŸ”„ æ›´æ–°æœ¬åœ°ç·©å­˜
    function updateCacheData(newData) {
        guestData = newData;
        lastDataUpdateTime = Date.now();
        saveCacheToStorage();
    }

    // ğŸ” ç·©å­˜ç‹€æ…‹æª¢æŸ¥ï¼ˆé–‹ç™¼è€…å·¥å…·ç”¨ï¼‰
    window.checkCacheStatus = function() {
        console.log('=== å©šç¦®ç³»çµ±ç·©å­˜ç‹€æ…‹ ===');
        console.log('è¨˜æ†¶é«”ç·©å­˜ç­†æ•¸:', guestData.length);
        console.log('æœ€å¾Œæ›´æ–°æ™‚é–“:', lastDataUpdateTime ? new Date(lastDataUpdateTime) : 'ç„¡');
        console.log('ç·©å­˜å¹´é½¡:', lastDataUpdateTime ? `${Math.round((Date.now() - lastDataUpdateTime) / 1000)}ç§’` : 'ç„¡');
        console.log('è¨˜æ†¶é«”ç·©å­˜æœ‰æ•ˆ:', Date.now() - lastDataUpdateTime < CACHE_DURATION);

        const storageData = localStorage.getItem(CACHE_KEY);
        const storageTime = localStorage.getItem(CACHE_TIME_KEY);
        console.log('localStorage æœ‰è³‡æ–™:', !!storageData);
        console.log('localStorage æ™‚é–“:', storageTime ? new Date(parseInt(storageTime)) : 'ç„¡');

        // æª¢æŸ¥ localStorage ä¸­çš„è³‡æ–™ç­†æ•¸
        if (storageData) {
            try {
                const parsed = JSON.parse(storageData);
                console.log('localStorage è³‡æ–™ç­†æ•¸:', parsed.length);
            } catch (e) {
                console.log('localStorage è³‡æ–™è§£æå¤±æ•—');
            }
        }

        if (guestData.length > 0) {
            console.log('å‰3ç­†è³‡æ–™:', guestData.slice(0, 3));
            console.log('æœ€å¾Œ3ç­†è³‡æ–™:', guestData.slice(-3));

            // æª¢æŸ¥æ˜¯å¦æœ‰ä¸åŒé é¢çš„è³‡æ–™
            const serialNumbers = guestData.map(g => g.serialNumber).sort((a, b) => a - b);
            console.log('åºè™Ÿç¯„åœ:', `${serialNumbers[0]} - ${serialNumbers[serialNumbers.length - 1]}`);
            console.log('æ˜¯å¦é€£çºŒ:', serialNumbers.length === (serialNumbers[serialNumbers.length - 1] - serialNumbers[0] + 1));
        }

        // è¿”å›ç‹€æ…‹æ‘˜è¦
        return {
            memoryCache: guestData.length,
            memoryCacheValid: Date.now() - lastDataUpdateTime < CACHE_DURATION,
            localStorageHasData: !!storageData,
            localStorageCount: storageData ? JSON.parse(storageData).length : 0,
            cacheAge: Math.round((Date.now() - lastDataUpdateTime) / 1000)
        };
    };

    // ğŸš€ æ€§èƒ½å„ªåŒ–ï¼šæ™ºèƒ½è¼‰å…¥è³‡æ–™
    function smartLoadGuestData(forceReload = false) {
        // å„ªå…ˆå˜—è©¦å¾ localStorage æ¢å¾©ç·©å­˜
        if (!forceReload && guestData.length === 0) {
            loadCacheFromStorage();
        }

        // æª¢æŸ¥è¨˜æ†¶é«”ç·©å­˜æ˜¯å¦æœ‰æ•ˆ
        if (!forceReload && guestData.length > 0 &&
            Date.now() - lastDataUpdateTime < CACHE_DURATION) {
            filteredData = [...guestData];
            renderGuestTable();
            return;
        }

        loadGuestData();
    }

    // ğŸ”„ æœ¬åœ°æ›´æ–°è³“å®¢è³‡æ–™ï¼ˆé¿å…é‡æ–°è«‹æ±‚ï¼‰
    function updateLocalGuestData(checkInData) {
        const { serialNumber, guestName, familyId, collectMoney, giftAmount, hasCake, cakeGiven } = checkInData;

        // æ›´æ–°å ±åˆ°æ“ä½œè€…
        const guestIndex = guestData.findIndex(guest =>
            guest.serialNumber === parseInt(serialNumber)
        );

        if (guestIndex === -1) {
            loadGuestData();
            return;
        }

        const now = new Date().toISOString();

        // ğŸ¯ å¥½å“å‘³ï¼šæ•¸æ“šæ›´æ–°çµ±ä¸€åŒ–
        const checkInUpdate = {
            checkedIn: true,
            timestamp: now
        };

        const giftUpdate = {
            collectMoney: Boolean(collectMoney),
            giftAmount: Number(giftAmount) || 0,
            hasCake: Boolean(hasCake),
            cakeGiven: Boolean(cakeGiven)
        };

        // ä¸»è¦å ±åˆ°è€…ç²å¾—å®Œæ•´æ›´æ–°
        guestData[guestIndex] = { ...guestData[guestIndex], ...checkInUpdate, ...giftUpdate };

        // å®¶åº­æˆå“¡åªç²å¾—å ±åˆ°ç‹€æ…‹æ›´æ–°ï¼Œç„¡ç‰¹æ®Šæƒ…æ³åˆ¤æ–·
        const updatedCount = familyId ? 
            updateFamilyMembers(familyId, guestIndex, checkInUpdate) + 1 : 1;

        // æ›´æ–°ç¯©é¸è³‡æ–™å’Œé¡¯ç¤º
        filteredData = [...guestData];
        if (currentSearchTerm) {
            filterGuests(currentSearchTerm);
        } else {
            renderGuestTable();
        }


        // ä¿å­˜æ›´æ–°å¾Œçš„è³‡æ–™åˆ° localStorage
        saveCacheToStorage();

        updatePaginationDisplay()
    }

    // ğŸ¯ å¥½å“å‘³ï¼šç´”å‡½æ•¸ï¼Œè·è²¬å–®ä¸€
    function updateFamilyMembers(familyId, skipIndex, updateData) {
        let count = 0;
        guestData.forEach((guest, index) => {
            if (guest.familyId === familyId && index !== skipIndex) {
                guestData[index] = { ...guestData[index], ...updateData };
                count++;
            }
        });
        return count;
    }

    // è¼‰å…¥å…¨éƒ¨è³“å®¢è³‡æ–™ - ä½¿ç”¨ JSONP
    function loadGuestData() {
        // æ¸…ç†ä¹‹å‰çš„ JSONP script æ¨™ç±¤
        const oldScript = document.querySelector('script[data-jsonp="guestlist"]');
        if (oldScript) {
            oldScript.remove();
        }

        // è¨­å®šå…¨åŸŸå›èª¿å‡½æ•¸
        window.handleGuestData = function(response) {

            // æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤æˆ–è€…æ˜¯åˆ†é è³‡æ–™æ ¼å¼
            if (response.error) {
                console.error('ä¼ºæœå™¨éŒ¯èª¤:', response.error);
                document.getElementById('guest-table-body').innerHTML = `
                    <tr>
                        <td colspan="5" class="table-cell text-center py-8">
                            <span class="material-symbols-outlined text-2xl text-red-500">error</span>
                            <div class="mt-2 text-red-500">è¼‰å…¥è³‡æ–™å¤±æ•—ï¼š${response.message || 'æœªçŸ¥éŒ¯èª¤'}</div>
                            <button onclick="loadGuestData()" class="btn-primary mt-2">
                                <span class="material-symbols-outlined">refresh</span> é‡æ–°è¼‰å…¥
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }

            // åˆ¤æ–·æ˜¯åˆ†é æ ¼å¼é‚„æ˜¯åŸæœ¬çš„é™£åˆ—æ ¼å¼
            if (response.data && Array.isArray(response.data)) {
                // æ–°çš„åˆ†é æ ¼å¼ï¼Œä½†æˆ‘å€‘å–æ‰€æœ‰é é¢çš„è³‡æ–™
                guestData = response.data;
            } else if (Array.isArray(response)) {
                // åŸæœ¬çš„é™£åˆ—æ ¼å¼
                guestData = response;
            } else {
                console.error('æœªçŸ¥çš„è³‡æ–™æ ¼å¼:', response);
                guestData = [];
            }


            // ğŸ¯ ç°¡å–®æœ‰æ•ˆï¼šå¦‚æœæœ‰åˆ†é å°±è‡ªå‹•è¼‰å…¥å…¨éƒ¨
            if (response.pagination && response.pagination.hasNextPage) {
                // ç›´æ¥è¼‰å…¥ä¸‹ä¸€é ä¸¦ç´¯ç©åˆ°ç¾æœ‰è³‡æ–™
                loadMorePages(response.pagination.currentPage + 1, guestData);
                return; // ç­‰å¾…æ‰€æœ‰é é¢è¼‰å…¥å®Œæˆå†è™•ç† UI
            } else {
                // åªæœ‰ä¸€é ï¼Œç›´æ¥å®Œæˆ UI æ›´æ–°
                finishDataLoadingAndUpdateUI(guestData);
            }
        };

        // å‰µå»º JSONP script æ¨™ç±¤ï¼Œä¸è¦åˆ†é åƒæ•¸ï¼Œå–å¾—å…¨éƒ¨è³‡æ–™
        const script = document.createElement('script');
        script.setAttribute('data-jsonp', 'guestlist');

        // ğŸš€ æ¼¸é€²å¼è¼‰å…¥ï¼šå…ˆå˜—è©¦ç²å–æ›´å¤šè³‡æ–™ï¼Œå¯¦éš›æ”¶åˆ°å¤šå°‘å°±ç·©å­˜å¤šå°‘
        const params = new URLSearchParams({
            callback: 'handleGuestData',
            limit: 999999, // å˜—è©¦ç²å–å…¨éƒ¨ï¼Œå¯¦éš›èƒ½æ‹¿å¤šå°‘å°±æ‹¿å¤šå°‘
            page: 1,
            _t: Date.now()
        });

        script.src = `${GOOGLE_SCRIPT_READ_URL}?${params.toString()}`;

        // éŒ¯èª¤è™•ç†
        script.onerror = function() {
            console.error('JSONP è«‹æ±‚å¤±æ•—');
            document.getElementById('guest-table-body').innerHTML = `
                <tr>
                    <td colspan="5" class="table-cell text-center py-8">
                        <span class="material-symbols-outlined text-2xl text-red-500">error</span>
                        <div class="mt-2 text-red-500">ç¶²è·¯é€£æ¥å¤±æ•—</div>
                        <button onclick="loadGuestData()" class="btn-primary mt-2">
                            <span class="material-symbols-outlined">refresh</span> é‡æ–°è¼‰å…¥
                        </button>
                    </td>
                </tr>
            `;
        };

        // æ·»åŠ åˆ°é é¢
        document.head.appendChild(script);

    }

    // çµ±ä¸€çš„ UI æ›´æ–°å‡½æ•¸
    function finishDataLoadingAndUpdateUI(finalData) {
        guestData = finalData;

        // åˆå§‹åŒ–ç¯©é¸è³‡æ–™
        filteredData = [...guestData];

        // è¨­ç½®è³‡æ–™æ›´æ–°æ™‚é–“ä¸¦ä¿å­˜è‡³ localStorage
        updateCacheData(guestData);


        // å¦‚æœæœ‰æœå°‹é—œéµå­—ï¼Œé€²è¡Œç¯©é¸
        if (currentSearchTerm) {
            filterGuests(currentSearchTerm);
        } else {
            // æ›´æ–°åˆ†é é¡¯ç¤º
            updatePaginationDisplay();
            renderGuestTable();
        }
    }

    // è¼‰å…¥å‰©é¤˜é é¢çš„è³‡æ–™
    function loadMorePages(pageNumber, accumulatedData) {
        // è¨­å®šé€™å€‹é é¢çš„å›èª¿å‡½æ•¸
        window[`handleGuestDataPage${pageNumber}`] = function(response) {

            let currentPageData = [];
            if (response.data && Array.isArray(response.data)) {
                currentPageData = response.data;
            } else if (Array.isArray(response)) {
                currentPageData = response;
            }

            // ç´¯ç©è³‡æ–™
            const totalData = [...accumulatedData, ...currentPageData];

            // æª¢æŸ¥æ˜¯å¦é‚„æœ‰ä¸‹ä¸€é 
            if (response.pagination && response.pagination.hasNextPage) {
                // ç¹¼çºŒè¼‰å…¥ä¸‹ä¸€é 
                loadMorePages(pageNumber + 1, totalData);
            } else {
                // æ‰€æœ‰é é¢è¼‰å…¥å®Œæˆï¼Œçµ±ä¸€æ›´æ–° UI
                finishDataLoadingAndUpdateUI(totalData);
            }
        };

        // å‰µå»ºæ–°çš„ JSONP script
        const script = document.createElement('script');
        script.setAttribute('data-jsonp', `guestlist-page-${pageNumber}`);

        const params = new URLSearchParams({
            callback: `handleGuestDataPage${pageNumber}`,
            page: pageNumber,
            _t: Date.now()
        });

        script.src = `${GOOGLE_SCRIPT_READ_URL}?${params.toString()}`;

        script.onerror = function() {
            console.error(`ç¬¬ ${pageNumber} é è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨å·²è¼‰å…¥çš„ ${accumulatedData.length} ç­†è³‡æ–™`);
            // è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨å·²æœ‰è³‡æ–™ï¼Œçµ±ä¸€æ›´æ–° UI
            finishDataLoadingAndUpdateUI(accumulatedData);
        };

        document.head.appendChild(script);
    }

    // æ›´æ–°åˆ†é é¡¯ç¤ºï¼ˆåŸºæ–¼æœ¬åœ°è³‡æ–™ï¼‰
    function updatePaginationDisplay() {
        updatePaginationInfo();
        updatePaginationButtons();
    }

    // æ›´æ–°åˆ†é è³‡è¨Šé¡¯ç¤º
    function updatePaginationInfo() {
        const totalRecords = filteredData.length;
        const start = totalRecords === 0 ? 0 : ((currentPage - 1) * itemsPerPage) + 1;
        const end = Math.min(currentPage * itemsPerPage, totalRecords);

        document.getElementById('pagination-info').textContent =
            `é¡¯ç¤ºç¬¬ ${start}-${end} ç­†ï¼Œå…± ${totalRecords} ç­†è³“å®¢`;
    }

    // æ›´æ–°åˆ†é æŒ‰éˆ•
    function updatePaginationButtons() {
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        const pageNumbers = document.getElementById('page-numbers');

        const totalRecords = filteredData.length;
        const totalPages = Math.ceil(totalRecords / itemsPerPage);
        const hasPrevPage = currentPage > 1;
        const hasNextPage = currentPage < totalPages;

        // ä¸Šä¸€é /ä¸‹ä¸€é æŒ‰éˆ•ç‹€æ…‹
        prevBtn.disabled = !hasPrevPage;
        nextBtn.disabled = !hasNextPage;

        // ç”Ÿæˆé ç¢¼æŒ‰éˆ•
        pageNumbers.innerHTML = '';

        // è¨ˆç®—é¡¯ç¤ºçš„é ç¢¼ç¯„åœ
        const maxButtons = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);

        // èª¿æ•´èµ·å§‹é é¢
        if (endPage - startPage + 1 < maxButtons) {
            startPage = Math.max(1, endPage - maxButtons + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.className = `px-3 py-2 text-sm font-medium border ${
                i === currentPage
                    ? 'bg-[var(--primary-color)] text-white border-[var(--primary-color)]'
                    : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'
            }`;
            button.onclick = () => goToPage(i);
            pageNumbers.appendChild(button);
        }
    }

    // è·³è½‰åˆ°æŒ‡å®šé é¢ï¼ˆå‰ç«¯åˆ†é ï¼‰
    function goToPage(page) {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            updatePaginationDisplay();
            renderGuestTable();
        }
    }

    // æ¸²æŸ“è³“å®¢è¡¨æ ¼ï¼ˆæ”¯æ´å®¶åº­ç¾¤çµ„æ©¢åœ“å½¢é¡¯ç¤ºï¼‰
    function renderGuestTable() {
        const tbody = document.getElementById('guest-table-body');

        if (filteredData.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="table-cell text-center py-8">
                        <span class="material-symbols-outlined text-2xl text-gray-400">person_off</span>
                        <div class="mt-2 text-gray-500">
                            ${currentSearchTerm ? 'æ²’æœ‰ç¬¦åˆæœå°‹æ¢ä»¶çš„è³“å®¢' : 'å°šç„¡è³“å®¢è³‡æ–™'}
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        // ğŸ¯ åŸºæ–¼å®Œæ•´å¿«å–è³‡æ–™çš„å‰ç«¯åˆ†é 
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const currentPageData = filteredData.slice(startIndex, endIndex);


        // æŒ‰å®¶åº­ç¾¤çµ„æ•´ç†è³‡æ–™
        const groupedData = groupGuestsByFamily(currentPageData);

        tbody.innerHTML = groupedData.map(guest => {
            const isCheckedIn = guest.checkedIn;
            const rowClass = isCheckedIn ? 'checked-in-row' : 'unchecked-row';
            const buttonClass = isCheckedIn ? 'btn-primary bg-green-200 text-green-800 hover:bg-green-300' : 'btn-primary';
            const buttonText = isCheckedIn ? '<span class="magic-wand-icon">edit</span> å·²å ±åˆ°' : '<span class="magic-wand-icon">login</span> æœªå ±åˆ°';
            const buttonAction = isCheckedIn ? `viewGuestDetails('${guest.serialNumber}')` : `goToCheckin('${guest.serialNumber}', '${guest.guestName}', ${guest.collectMoney}, ${guest.hasCake})`;

            // æ·»åŠ å®¶åº­ç¾¤çµ„æ¨£å¼
            const familyGroupClass = guest.familyGroupClass || '';
            const familyDisplay = guest.familyId ? `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">${guest.familyId}</span>` : '-';

            return `
                <tr class="transition-colors ${rowClass} ${familyGroupClass}">
                    <td class="table-cell">${guest.serialNumber}</td>
                    <td class="table-cell font-medium">${guest.guestName}</td>
                    <td class="table-cell text-center">${familyDisplay}</td>
                    <td class="table-cell text-center">
                        <input ${guest.collectMoney ? 'checked' : ''}
                               class="checkbox-custom ${isCheckedIn ? 'border-green-300' : ''}"
                               type="checkbox" disabled/>
                    </td>
                    <td class="table-cell text-center">
                        <input ${guest.hasCake ? 'checked' : ''}
                               class="checkbox-custom ${isCheckedIn ? 'border-green-300' : ''}"
                               type="checkbox" disabled/>
                    </td>
                    <td class="table-cell text-right">
                        <button class="${buttonClass}" onclick="${buttonAction}">
                            ${buttonText}
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // ğŸ¯ å¥½å“å‘³é‡å¯«ï¼šçœŸæ­£æ¶ˆé™¤ç‰¹æ®Šæƒ…æ³
    function groupGuestsByFamily(guests) {
        const result = [];
        const familyMap = new Map();
        
        // åˆ†é›¢å®¶åº­æˆå“¡å’Œå€‹äººè³“å®¢
        guests.forEach(guest => {
            if (guest.familyId) {
                if (!familyMap.has(guest.familyId)) {
                    familyMap.set(guest.familyId, []);
                }
                familyMap.get(guest.familyId).push(guest);
            } else {
                // å€‹äººè³“å®¢ä¸éœ€è¦ä»»ä½•å®¶åº­æ¨™è¨˜
                guest.familyGroupClass = '';
                result.push(guest);
            }
        });

        // åªè™•ç†çœŸæ­£çš„å®¶åº­ç¾¤çµ„
        familyMap.forEach(family => {
            family.forEach((guest, index) => {
                guest.familyGroupClass = calculateFamilyPosition(family.length, index);
                result.push(guest);
            });
        });

        return result;
    }

    // ç´”å‡½æ•¸ï¼šåªè™•ç†çœŸå¯¦çš„å®¶åº­ä½ç½®
    function calculateFamilyPosition(familySize, index) {
        if (familySize === 1) return 'family-group-single';
        if (index === 0) return 'family-group-first';
        if (index === familySize - 1) return 'family-group-last';
        return 'family-group-middle';
    }

    // æŸ¥çœ‹è³“å®¢è©³ç´°è³‡è¨Š
    function viewGuestDetails(serialNumber) {
        const guest = guestData.find(g => g.serialNumber === parseInt(serialNumber));
        if (guest) {
            const details = `
è³“å®¢ç·¨è™Ÿ: ${guest.serialNumber}
å§“å: ${guest.guestName}
æ”¶ç¦®é‡‘: ${guest.collectMoney ? 'æ˜¯' : 'å¦'}
${guest.collectMoney && guest.giftAmount ? `ç¦®é‡‘é‡‘é¡: ${guest.giftAmount}` : ''}
æœ‰å–œé¤…: ${guest.hasCake ? 'æ˜¯' : 'å¦'}
ç™¼æ”¾å–œé¤…: ${guest.cakeGiven ? 'æ˜¯' : 'å¦'}
å ±åˆ°æ™‚é–“: ${guest.timestamp ? new Date(guest.timestamp).toLocaleString('zh-TW') : 'å°šæœªå ±åˆ°'}
            `;
            alert(details);
        }
    }

    // è·³è½‰åˆ°å ±åˆ°ç•«é¢
    function goToCheckin(serialNumber, guestName, collectMoney, hasCake) {
        // å¾ guestData ä¸­æ‰¾åˆ°è©²è³“å®¢çš„å®Œæ•´è³‡è¨Š
        const guestInfo = guestData.find(guest => guest.serialNumber === parseInt(serialNumber));

        // é™¤éŒ¯ç¢ºèªï¼šé¡å‹å•é¡Œå·²ä¿®æ­£
        console.log('âœ… é¡å‹ä¿®æ­£å¾ŒæŸ¥è©¢çµæœ:', {
            originalSerialNumber: serialNumber,
            serialNumberType: typeof serialNumber,
            parsedSerialNumber: parseInt(serialNumber),
            foundGuestInfo: !!guestInfo,
            guestInfoFamilyId: guestInfo ? guestInfo.familyId : 'æœªæ‰¾åˆ°è³“å®¢'
        });

        // åŸºæœ¬åƒæ•¸
        const params = new URLSearchParams({
            sn: serialNumber,
            name: encodeURIComponent(guestName),
            collectMoney: collectMoney,
            hasCake: hasCake
        });

        // å¦‚æœæœ‰å®¶åº­ç·¨è™Ÿï¼ŒåŠ å…¥å®¶åº­æˆå“¡è³‡è¨Š
        if (guestInfo && guestInfo.familyId) {
            // æ‰¾åˆ°åŒå®¶åº­çš„æ‰€æœ‰æˆå“¡
            const familyMembers = guestData.filter(guest => guest.familyId === guestInfo.familyId);


            if (familyMembers.length > 1) {
                // å°‡å®¶åº­æˆå“¡è³‡è¨Šç·¨ç¢¼ç‚º JSON å­—ä¸²
                const familyData = familyMembers.map(member => ({
                    memberName: member.guestName,
                    isCheckedIn: member.checkedIn
                }));

                params.set('familyId', guestInfo.familyId);
                params.set('familyMembers', encodeURIComponent(JSON.stringify(familyData)));

            } else {
            }
        } else {
        }

        // è·³è½‰åˆ°å ±åˆ°ç•«é¢
        window.location.href = `checkin.html?${params.toString()}`;
    }

    // ğŸ”„ æ™ºèƒ½åˆ·æ–°è³‡æ–™
    function refreshData(forceReload = false) {
        if (forceReload) {
            document.getElementById('guest-table-body').innerHTML = `
                <tr id="loading-row">
                    <td colspan="5" class="table-cell text-center py-8">
                        <span class="material-symbols-outlined animate-spin text-2xl text-[var(--primary-color)]">refresh</span>
                        <div class="mt-2 text-gray-500">é‡æ–°è¼‰å…¥è³‡æ–™ä¸­...</div>
                    </td>
                </tr>
            `;
            loadGuestData();
        } else {
            // ä½¿ç”¨æ™ºèƒ½è¼‰å…¥
            smartLoadGuestData();
        }
    }

    // æœç´¢åŠŸèƒ½ï¼ˆæœ¬åœ°æœå°‹ + å‰ç«¯åˆ†é ï¼‰
    function filterGuests(searchTerm) {
        currentSearchTerm = searchTerm.trim();

        if (currentSearchTerm === '') {
            // æ²’æœ‰æœå°‹æ¢ä»¶ï¼Œé¡¯ç¤ºå…¨éƒ¨è³‡æ–™
            filteredData = [...guestData];
        } else {
            // æœ‰æœå°‹æ¢ä»¶ï¼Œéæ¿¾è³‡æ–™
            const searchLower = currentSearchTerm.toLowerCase();
            filteredData = guestData.filter(guest => {
                const matchesSerial = guest.serialNumber.toString().toLowerCase().includes(searchLower);
                const matchesName = guest.guestName.toString().toLowerCase().includes(searchLower);
                return matchesSerial || matchesName;
            });
        }

        // é‡ç½®åˆ°ç¬¬ä¸€é 
        currentPage = 1;

        // æ›´æ–°é¡¯ç¤º
        updatePaginationDisplay();
        renderGuestTable();

        // é¡¯ç¤º/éš±è—æ¸…é™¤æŒ‰éˆ•
        const clearButton = document.getElementById('clear-search');
        if (currentSearchTerm) {
            clearButton.classList.remove('hidden');
        } else {
            clearButton.classList.add('hidden');
        }
    }

    // æ¸…é™¤æœç´¢
    function clearSearch() {
        const searchInput = document.getElementById('search-input');
        searchInput.value = '';
        filterGuests('');
    }

    // æ·»åŠ åˆ·æ–°æŒ‰éˆ•åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', function() {
        // æœç´¢åŠŸèƒ½äº‹ä»¶ç¶å®š
        const searchInput = document.getElementById('search-input');
        const clearButton = document.getElementById('clear-search');

        // å³æ™‚æœç´¢
        searchInput.addEventListener('input', function(e) {
            filterGuests(e.target.value);
        });

        // æ¸…é™¤æœç´¢
        clearButton.addEventListener('click', clearSearch);

        // Enter éµæœç´¢
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                filterGuests(e.target.value);
            }
        });

        // æ·»åŠ åˆ·æ–°æŒ‰éˆ•åˆ°æ¨™é¡Œæ—é‚Š
        const headerDiv = document.querySelector('main .flex.items-center.justify-between');
        const refreshButton = document.createElement('button');
        refreshButton.className = 'btn-primary ml-4';
        refreshButton.innerHTML = '<span class="material-symbols-outlined">refresh</span> åˆ·æ–°è³‡æ–™';
        refreshButton.onclick = () => refreshData(true); // å¼·åˆ¶é‡æ–°è¼‰å…¥

        const addGuestButton = headerDiv.querySelector('button');
        addGuestButton.parentNode.insertBefore(refreshButton, addGuestButton);

        // åˆ†é æŒ‰éˆ•äº‹ä»¶
        document.getElementById('prev-page').addEventListener('click', function() {
            if (currentPage > 1) {
                goToPage(currentPage - 1);
            }
        });

        document.getElementById('next-page').addEventListener('click', function() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (currentPage < totalPages) {
                goToPage(currentPage + 1);
            }
        });

        // ğŸš€ æ™ºèƒ½è¼‰å…¥ - æª¢æŸ¥æ˜¯å¦å¾å ±åˆ°ç•«é¢å›è·³
        const urlParams = new URLSearchParams(window.location.search);
        const isLocalUpdate = urlParams.get('localUpdate') === 'true';

        if (isLocalUpdate) {
            // å¾ URL åƒæ•¸è§£æå ±åˆ°è³‡è¨Š
            const checkInData = {
                serialNumber: urlParams.get('sn'),
                guestName: decodeURIComponent(urlParams.get('name') || ''),
                collectMoney: urlParams.get('collectMoney') === 'true',
                giftAmount: parseInt(urlParams.get('giftAmount') || '0'),
                hasCake: urlParams.get('hasCake') === 'true',
                cakeGiven: urlParams.get('cakeGiven') === 'true'
            };


            // âœ… æª¢æŸ¥æ˜¯å¦æœ‰ç¾æœ‰ç·©å­˜è³‡æ–™ï¼ˆåŒ…æ‹¬ localStorageï¼‰
            if (guestData.length === 0) {
                loadCacheFromStorage(); // å˜—è©¦å¾ localStorage æ¢å¾©
            }

            if (guestData.length > 0) {

                // ç›´æ¥ä½¿ç”¨ç·©å­˜é€²è¡Œæœ¬åœ°æ›´æ–°
                const guest = guestData.find(g => g.serialNumber === parseInt(checkInData.serialNumber));
                if (guest) {
                    checkInData.familyId = guest.familyId;
                    updateLocalGuestData(checkInData);
                } else {
                    loadGuestData();
                }
            } else {

                // è¼‰å…¥è³‡æ–™å¾ŒåŸ·è¡Œæœ¬åœ°æ›´æ–°
                const originalCallback = window.handleGuestData;

                window.handleGuestData = function(response) {
                    // åŸ·è¡ŒåŸå§‹çš„è³‡æ–™è¼‰å…¥é‚è¼¯
                    originalCallback(response);

                    // å¦‚æœè³‡æ–™è¼‰å…¥æˆåŠŸï¼ŒåŸ·è¡Œæœ¬åœ°æ›´æ–°
                    if (guestData.length > 0) {
                        // æ‰¾åˆ°å®¶åº­IDä¾†æ­£ç¢ºæ›´æ–°
                        const guest = guestData.find(g => g.serialNumber === parseInt(checkInData.serialNumber));
                        if (guest) {
                            checkInData.familyId = guest.familyId;
                            updateLocalGuestData(checkInData);
                        }
                    }

                    // æ¢å¾©åŸå§‹å›èª¿
                    window.handleGuestData = originalCallback;
                };

                loadGuestData();
            }

            // æ¸…ç† URL åƒæ•¸
            window.history.replaceState({}, document.title, window.location.pathname);
        } else if (urlParams.has('refresh')) {
            // èˆŠç‰ˆæœ¬ç›¸å®¹æ€§ï¼šå¼·åˆ¶åˆ·æ–°
            loadGuestData();
            window.history.replaceState({}, document.title, window.location.pathname);
        } else {
            // æ­£å¸¸æ™ºèƒ½è¼‰å…¥
            smartLoadGuestData();
        }

        // ğŸ• é™ä½è‡ªå‹•åˆ·æ–°é »ç‡ï¼šæ¯5åˆ†é˜æ™ºèƒ½åˆ·æ–°
        setInterval(() => smartLoadGuestData(true), 5 * 60 * 1000);
    });
</script>

</body></html>