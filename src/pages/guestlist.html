<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Guest List - Enchanted Check-In</title>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Newsreader%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" onload="this.rel='stylesheet'" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
<script src="../config/config.js"></script>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<style type="text/tailwindcss">
        :root {
            --primary-color: #1791cf;
            --secondary-color: #f0f3f4;
            --text-color: #111518;
            --background-color: #f3e9d8;
            --accent-color: #e0f7fa;
            --subtle-border: #e0e0e0;
            --checked-in-bg: #e8f5e9;
            --unchecked-bg: #ffffff;
            --checked-in-text: #2e7d32;
            --unchecked-text: #111518;
        }
        body {
            font-family: 'Newsreader', 'Noto Sans', sans-serif;
        }
        .checkbox-custom {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid var(--subtle-border);
            border-radius: 0.375rem;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease-in-out;
            background-color: transparent;
        }
        .checkbox-custom:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .checkbox-custom:checked::after {
            content: "‚úî";
            color: white;
            font-size: 0.8rem;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-primary:hover {
            background-color: #147ab3;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .magic-wand-icon {
            font-family: 'Material Symbols Outlined';
            font-weight: normal;
            font-style: normal;
            font-size: 20px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
        }
        .table-header {
             color: #ffffff;
             font-weight: 700;
             padding: 1rem 1.5rem;
             text-align: left;
             font-size: 0.875rem;
             text-transform: uppercase;
             letter-spacing: 0.05em;
        }
        .table-cell {
            padding: 1rem 1.5rem;
            white-space: nowrap;
        }
        .checked-in-row {
            background-color: var(--checked-in-bg);
            color: var(--checked-in-text);
        }
         .checked-in-row .checkbox-custom {
            border-color: #a5d6a7;
        }
        .unchecked-row {
            background-color: var(--unchecked-bg);
            color: var(--unchecked-text);
        }
        .unchecked-row .checkbox-custom {
             border-color: #e0e0e0;
        }

        /* ÂÆ∂Â∫≠Áæ§ÁµÑÊ®£Âºè - Á≤óÊ°ÜÁâàÊú¨ */
        .family-group-first {
            border: none;
            border-radius: 8px 8px 0 0;
            background: rgba(23, 145, 207, 0.02);
        }

        .family-group-middle {
            border: none;
            background: rgba(23, 145, 207, 0.02);
        }

        .family-group-last {
            border: none;
            border-radius: 0 0 8px 8px;
            background: rgba(23, 145, 207, 0.02);
        }

        .family-group-single {
            border: none;
            border-radius: 8px;
            background: rgba(23, 145, 207, 0.02);
        }

        /* ÂÆ∂Â∫≠Áæ§ÁµÑÂ∑≤Â†±Âà∞Ê®£Âºè - Á∂†Â∫ïÈªëÂ≠ó */
        .family-group-first.checked-in-row {
            background-color: #e8f5e8;
            color: #000000;
            border-color: #4caf50;
        }

        .family-group-middle.checked-in-row {
            background-color: #e8f5e8;
            color: #000000;
            border-color: #4caf50;
        }

        .family-group-last.checked-in-row {
            background-color: #e8f5e8;
            color: #000000;
            border-color: #4caf50;
        }

        .family-group-single.checked-in-row {
            background-color: #e8f5e8;
            color: #000000;
            border-color: #4caf50;
        }

        /* ÂÆ∂Â∫≠Á∑®ËôüÊ®ôË®ò */
        .family-group-first .table-cell:first-child::after,
        .family-group-single .table-cell:first-child::after {
            content: "üë™";
            position: absolute;
            margin-left: 5px;
            font-size: 12px;
            opacity: 0.7;
        }
    </style>
</head>
<body class="bg-[var(--background-color)]">
<div class="relative flex size-full min-h-screen flex-col group/design-root overflow-x-hidden">
<div class="layout-container flex h-full grow flex-col">
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-[var(--subtle-border)] bg-white px-10 py-4 shadow-sm">
<div class="flex items-center gap-3 text-[var(--text-color)]">
<span class="material-symbols-outlined text-3xl text-[var(--primary-color)]">auto_stories</span>
<h1 class="text-xl font-bold leading-tight tracking-[-0.015em]">Enchanted Check-In</h1>
</div>
<div class="flex flex-1 justify-end gap-6">
<nav class="flex items-center gap-8">
<a class="text-sm font-medium text-[var(--text-color)] hover:text-[var(--primary-color)] transition-colors" href="#">Dashboard</a>
<a class="text-sm font-medium text-[var(--primary-color)] font-semibold" href="#">Guests</a>
<a class="text-sm font-medium text-[var(--text-color)] hover:text-[var(--primary-color)] transition-colors" href="#">Tables</a>
<a class="text-sm font-medium text-[var(--text-color)] hover:text-[var(--primary-color)] transition-colors" href="#">Gifts</a>
</nav>
<div class="flex items-center gap-4">
<button class="flex size-10 cursor-pointer items-center justify-center rounded-full bg-[var(--secondary-color)] text-[var(--text-color)] transition-colors hover:bg-gray-200">
<span class="material-symbols-outlined">notifications</span>
</button>
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 border-2 border-white shadow-md" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAzoLzGX5LzjT3jrnVLh1olWlJv05hkIF-_4qpqB7r3vt_6DxQoFKqlER0FwQC8_ovDJtJbJNrZKOnh1hSVs9rwgpEToPlx8yQDXhBy17Fc1d-_dRUvIy-CidFexPgY3FqRWoR3TCzU1oV7tMiWTH625DSiyPEc8dJhUu3q22m088UVWfE_haSPGhm5-fsXAEZ-bX5n2WAEFT8WFsOtMsZFRTQiR7v199fv3ph7Is0BX9mm05BO0wDLmkKqMKlWATVFEsluPKaILAk");'></div>
</div>
</div>
</header>
<main class="flex-1 p-6 sm:p-10">
<div class="mx-auto max-w-7xl">
<div class="flex items-center justify-between mb-8">
<h2 class="text-3xl font-bold text-[var(--text-color)] tracking-tight">Guest List</h2>
<button class="btn-primary" type="button">
<span class="material-symbols-outlined text-lg">person_add</span> Add New Guest
            </button>
</div>
<div class="bg-white rounded-2xl shadow-lg border border-[var(--subtle-border)] overflow-hidden">
<!-- ÊêúÂ∞ãÊ¨Ñ‰Ωç -->
<div class="p-6 border-b border-[var(--subtle-border)]">
<div class="relative max-w-md">
<span class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</span>
<input type="text" id="search-input" placeholder="ÊêúÂ∞ãÁ∑®ËôüÊàñÂßìÂêç..."
       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none transition-all">
<button id="clear-search" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden">
<span class="material-symbols-outlined text-lg">close</span>
</button>
</div>
</div>
<div class="overflow-x-auto">
<table class="w-full text-sm">
<thead class="bg-gray-800">
<tr>
<th class="table-header">S/N</th>
<th class="table-header">Guest Name</th>
<th class="table-header text-center">Family</th>
<th class="table-header text-center">Collect Gift Money</th>
<th class="table-header text-center">Has Wedding Cake</th>
<th class="table-header"></th>
</tr>
</thead>
<tbody id="guest-table-body" class="divide-y divide-[var(--subtle-border)]">
                            <!-- ËºâÂÖ•‰∏≠ÁöÑÊèêÁ§∫ -->
                            <tr id="loading-row">
                                <td colspan="6" class="table-cell text-center py-8">
                                    <span class="material-symbols-outlined animate-spin text-2xl text-[var(--primary-color)]">refresh</span>
                                    <div class="mt-2 text-gray-500">ËºâÂÖ•Ë≥ìÂÆ¢Ë≥áÊñô‰∏≠...</div>
                                </td>
                            </tr>
                        </tbody>
</table>
</div>

<!-- ÂàÜÈ†ÅË≥áË®äÂíåÂ∞éËà™ -->
<div class="px-6 py-4 border-t border-[var(--subtle-border)] bg-gray-50">
<div class="flex flex-col sm:flex-row justify-between items-center gap-4">
<!-- Ë≥áË®äÈ°ØÁ§∫ -->
<div class="text-sm text-gray-600">
<span id="pagination-info">È°ØÁ§∫Á¨¨ 1-20 Á≠ÜÔºåÂÖ± 0 Á≠ÜË≥ìÂÆ¢</span>
</div>

<!-- ÂàÜÈ†ÅÂ∞éËà™ -->
<div class="flex items-center space-x-1">
<!-- ‰∏ä‰∏ÄÈ†ÅÊåâÈàï -->
<button id="prev-page" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-l-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
<span class="material-symbols-outlined text-lg">chevron_left</span>
</button>

<!-- È†ÅÁ¢ºÊåâÈàïÂÆπÂô® -->
<div id="page-numbers" class="flex space-x-1">
<!-- È†ÅÁ¢ºÊåâÈàïÊúÉÂãïÊÖãÁîüÊàê -->
</div>

<!-- ‰∏ã‰∏ÄÈ†ÅÊåâÈàï -->
<button id="next-page" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-r-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
<span class="material-symbols-outlined text-lg">chevron_right</span>
</button>
</div>
</div>
</div>

</div>
</div>
</main>
</div>
</div>

<script>
    // Google Apps Script URL ÂæûÈÖçÁΩÆÊñá‰ª∂ËºâÂÖ•
    const GOOGLE_SCRIPT_READ_URL = window.CONFIG?.GOOGLE_SCRIPT_URL || (() => { alert('Ë´ãÂÖàË®≠ÂÆö config.js ÈÖçÁΩÆÊñá‰ª∂ÔºÅ'); return ''; })();

    let guestData = []; // ÂÖ®ÈÉ®Ë≥ìÂÆ¢Ë≥áÊñô
    let filteredData = []; // ÊêúÂ∞ãÈÅéÊøæÂæåÁöÑË≥áÊñô
    let currentSearchTerm = ''; // ÁõÆÂâçÁöÑÊêúÂ∞ãÈóúÈçµÂ≠ó
    let lastDataUpdateTime = 0; // ÊúÄÂæåË≥áÊñôÊõ¥Êñ∞ÊôÇÈñì

    // üóÑÔ∏è ÊåÅ‰πÖÂåñÁ∑©Â≠òÈÖçÁΩÆ
    const CACHE_KEY = 'wedding_guest_data';
    const CACHE_TIME_KEY = 'wedding_guest_data_time';
    const CACHE_DURATION = 5 * 60 * 1000; // 5ÂàÜÈêòÁ∑©Â≠ò

    // ÂàÜÈ†ÅËÆäÊï∏
    const itemsPerPage = 20;
    let currentPage = 1;

    // üóÑÔ∏è ÊåÅ‰πÖÂåñÁ∑©Â≠òÁÆ°ÁêÜ
    function saveCacheToStorage() {
        try {
            localStorage.setItem(CACHE_KEY, JSON.stringify(guestData));
            localStorage.setItem(CACHE_TIME_KEY, lastDataUpdateTime.toString());
        } catch (error) {
            console.warn('‚ö†Ô∏è localStorage ‰øùÂ≠òÂ§±Êïó:', error);
        }
    }

    function loadCacheFromStorage() {
        try {
            const cachedData = localStorage.getItem(CACHE_KEY);
            const cachedTime = localStorage.getItem(CACHE_TIME_KEY);

            if (cachedData && cachedTime) {
                const cacheAge = Date.now() - parseInt(cachedTime);
                if (cacheAge < CACHE_DURATION) {
                    guestData = JSON.parse(cachedData);
                    lastDataUpdateTime = parseInt(cachedTime);
                    return true;
                } else {
                    clearCacheFromStorage();
                }
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è localStorage ËÆÄÂèñÂ§±Êïó:', error);
            clearCacheFromStorage();
        }
        return false;
    }

    function clearCacheFromStorage() {
        try {
            localStorage.removeItem(CACHE_KEY);
            localStorage.removeItem(CACHE_TIME_KEY);
        } catch (error) {
            console.warn('‚ö†Ô∏è localStorage Ê∏ÖÈô§Â§±Êïó:', error);
        }
    }

    // üîÑ Êõ¥Êñ∞Êú¨Âú∞Á∑©Â≠ò
    function updateCacheData(newData) {
        guestData = newData;
        lastDataUpdateTime = Date.now();
        saveCacheToStorage();
    }

    // üîç Á∑©Â≠òÁãÄÊÖãÊ™¢Êü•ÔºàÈñãÁôºËÄÖÂ∑•ÂÖ∑Áî®Ôºâ
    window.checkCacheStatus = function() {
        console.log('=== Â©öÁ¶ÆÁ≥ªÁµ±Á∑©Â≠òÁãÄÊÖã ===');
        console.log('Ë®òÊÜ∂È´îÁ∑©Â≠òÁ≠ÜÊï∏:', guestData.length);
        console.log('ÊúÄÂæåÊõ¥Êñ∞ÊôÇÈñì:', lastDataUpdateTime ? new Date(lastDataUpdateTime) : 'ÁÑ°');
        console.log('Á∑©Â≠òÂπ¥ÈΩ°:', lastDataUpdateTime ? `${Math.round((Date.now() - lastDataUpdateTime) / 1000)}Áßí` : 'ÁÑ°');
        console.log('Ë®òÊÜ∂È´îÁ∑©Â≠òÊúâÊïà:', Date.now() - lastDataUpdateTime < CACHE_DURATION);

        const storageData = localStorage.getItem(CACHE_KEY);
        const storageTime = localStorage.getItem(CACHE_TIME_KEY);
        console.log('localStorage ÊúâË≥áÊñô:', !!storageData);
        console.log('localStorage ÊôÇÈñì:', storageTime ? new Date(parseInt(storageTime)) : 'ÁÑ°');

        // Ê™¢Êü• localStorage ‰∏≠ÁöÑË≥áÊñôÁ≠ÜÊï∏
        if (storageData) {
            try {
                const parsed = JSON.parse(storageData);
                console.log('localStorage Ë≥áÊñôÁ≠ÜÊï∏:', parsed.length);
            } catch (e) {
                console.log('localStorage Ë≥áÊñôËß£ÊûêÂ§±Êïó');
            }
        }

        if (guestData.length > 0) {
            console.log('Ââç3Á≠ÜË≥áÊñô:', guestData.slice(0, 3));
            console.log('ÊúÄÂæå3Á≠ÜË≥áÊñô:', guestData.slice(-3));

            // Ê™¢Êü•ÊòØÂê¶Êúâ‰∏çÂêåÈ†ÅÈù¢ÁöÑË≥áÊñô
            const serialNumbers = guestData.map(g => g.serialNumber).sort((a, b) => a - b);
            console.log('Â∫èËôüÁØÑÂúç:', `${serialNumbers[0]} - ${serialNumbers[serialNumbers.length - 1]}`);
            console.log('ÊòØÂê¶ÈÄ£Á∫å:', serialNumbers.length === (serialNumbers[serialNumbers.length - 1] - serialNumbers[0] + 1));
        }

        // ËøîÂõûÁãÄÊÖãÊëòË¶Å
        return {
            memoryCache: guestData.length,
            memoryCacheValid: Date.now() - lastDataUpdateTime < CACHE_DURATION,
            localStorageHasData: !!storageData,
            localStorageCount: storageData ? JSON.parse(storageData).length : 0,
            cacheAge: Math.round((Date.now() - lastDataUpdateTime) / 1000)
        };
    };

    // üöÄ ÊÄßËÉΩÂÑ™ÂåñÔºöÊô∫ËÉΩËºâÂÖ•Ë≥áÊñô
    function smartLoadGuestData(forceReload = false) {
        // ÂÑ™ÂÖàÂòóË©¶Âæû localStorage ÊÅ¢Âæ©Á∑©Â≠ò
        if (!forceReload && guestData.length === 0) {
            loadCacheFromStorage();
        }

        // Ê™¢Êü•Ë®òÊÜ∂È´îÁ∑©Â≠òÊòØÂê¶ÊúâÊïà
        if (!forceReload && guestData.length > 0 &&
            Date.now() - lastDataUpdateTime < CACHE_DURATION) {
            filteredData = [...guestData];
            renderGuestTable();
            return;
        }

        loadGuestData();
    }

    // üîÑ Êú¨Âú∞Êõ¥Êñ∞Ë≥ìÂÆ¢Ë≥áÊñôÔºàÈÅøÂÖçÈáçÊñ∞Ë´ãÊ±ÇÔºâ
    function updateLocalGuestData(checkInData) {
        const { serialNumber, guestName, familyId, collectMoney, giftAmount, hasCake, cakeGiven } = checkInData;

        // Êõ¥Êñ∞Â†±Âà∞Êìç‰ΩúËÄÖ
        const guestIndex = guestData.findIndex(guest =>
            guest.serialNumber === parseInt(serialNumber)
        );

        if (guestIndex === -1) {
            loadGuestData();
            return;
        }

        const now = new Date().toISOString();

        // üéØ Â•ΩÂìÅÂë≥ÔºöÊï∏ÊìöÊõ¥Êñ∞Áµ±‰∏ÄÂåñ
        const checkInUpdate = {
            checkedIn: true,
            timestamp: now
        };

        const giftUpdate = {
            collectMoney: Boolean(collectMoney),
            giftAmount: Number(giftAmount) || 0,
            hasCake: Boolean(hasCake),
            cakeGiven: Boolean(cakeGiven)
        };

        // ‰∏ªË¶ÅÂ†±Âà∞ËÄÖÁç≤ÂæóÂÆåÊï¥Êõ¥Êñ∞
        guestData[guestIndex] = { ...guestData[guestIndex], ...checkInUpdate, ...giftUpdate };

        // ÂÆ∂Â∫≠ÊàêÂì°Âè™Áç≤ÂæóÂ†±Âà∞ÁãÄÊÖãÊõ¥Êñ∞ÔºåÁÑ°ÁâπÊÆäÊÉÖÊ≥ÅÂà§Êñ∑
        const updatedCount = familyId ? 
            updateFamilyMembers(familyId, guestIndex, checkInUpdate) + 1 : 1;

        // Êõ¥Êñ∞ÁØ©ÈÅ∏Ë≥áÊñôÂíåÈ°ØÁ§∫
        filteredData = [...guestData];
        if (currentSearchTerm) {
            filterGuests(currentSearchTerm);
        } else {
            renderGuestTable();
        }


        // ‰øùÂ≠òÊõ¥Êñ∞ÂæåÁöÑË≥áÊñôÂà∞ localStorage
        saveCacheToStorage();

        updatePaginationDisplay()
    }

    // üéØ Â•ΩÂìÅÂë≥ÔºöÁ¥îÂáΩÊï∏ÔºåËÅ∑Ë≤¨ÂñÆ‰∏Ä
    function updateFamilyMembers(familyId, skipIndex, updateData) {
        let count = 0;
        guestData.forEach((guest, index) => {
            if (guest.familyId === familyId && index !== skipIndex) {
                guestData[index] = { ...guestData[index], ...updateData };
                count++;
            }
        });
        return count;
    }

    // ËºâÂÖ•ÂÖ®ÈÉ®Ë≥ìÂÆ¢Ë≥áÊñô - ‰ΩøÁî® JSONP
    function loadGuestData() {
        // Ê∏ÖÁêÜ‰πãÂâçÁöÑ JSONP script Ê®ôÁ±§
        const oldScript = document.querySelector('script[data-jsonp="guestlist"]');
        if (oldScript) {
            oldScript.remove();
        }

        // Ë®≠ÂÆöÂÖ®ÂüüÂõûË™øÂáΩÊï∏
        window.handleGuestData = function(response) {

            // Ê™¢Êü•ÊòØÂê¶ÊúâÈåØË™§ÊàñËÄÖÊòØÂàÜÈ†ÅË≥áÊñôÊ†ºÂºè
            if (response.error) {
                console.error('‰º∫ÊúçÂô®ÈåØË™§:', response.error);
                document.getElementById('guest-table-body').innerHTML = `
                    <tr>
                        <td colspan="5" class="table-cell text-center py-8">
                            <span class="material-symbols-outlined text-2xl text-red-500">error</span>
                            <div class="mt-2 text-red-500">ËºâÂÖ•Ë≥áÊñôÂ§±ÊïóÔºö${response.message || 'Êú™Áü•ÈåØË™§'}</div>
                            <button onclick="loadGuestData()" class="btn-primary mt-2">
                                <span class="material-symbols-outlined">refresh</span> ÈáçÊñ∞ËºâÂÖ•
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }

            // Âà§Êñ∑ÊòØÂàÜÈ†ÅÊ†ºÂºèÈÇÑÊòØÂéüÊú¨ÁöÑÈô£ÂàóÊ†ºÂºè
            if (response.data && Array.isArray(response.data)) {
                // Êñ∞ÁöÑÂàÜÈ†ÅÊ†ºÂºèÔºå‰ΩÜÊàëÂÄëÂèñÊâÄÊúâÈ†ÅÈù¢ÁöÑË≥áÊñô
                guestData = response.data;
            } else if (Array.isArray(response)) {
                // ÂéüÊú¨ÁöÑÈô£ÂàóÊ†ºÂºè
                guestData = response;
            } else {
                console.error('Êú™Áü•ÁöÑË≥áÊñôÊ†ºÂºè:', response);
                guestData = [];
            }


            // üéØ Á∞°ÂñÆÊúâÊïàÔºöÂ¶ÇÊûúÊúâÂàÜÈ†ÅÂ∞±Ëá™ÂãïËºâÂÖ•ÂÖ®ÈÉ®
            if (response.pagination && response.pagination.hasNextPage) {
                // Áõ¥Êé•ËºâÂÖ•‰∏ã‰∏ÄÈ†Å‰∏¶Á¥ØÁ©çÂà∞ÁèæÊúâË≥áÊñô
                loadMorePages(response.pagination.currentPage + 1, guestData);
                return; // Á≠âÂæÖÊâÄÊúâÈ†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÂÜçËôïÁêÜ UI
            } else {
                // Âè™Êúâ‰∏ÄÈ†ÅÔºåÁõ¥Êé•ÂÆåÊàê UI Êõ¥Êñ∞
                finishDataLoadingAndUpdateUI(guestData);
            }
        };

        // ÂâµÂª∫ JSONP script Ê®ôÁ±§Ôºå‰∏çË¶ÅÂàÜÈ†ÅÂèÉÊï∏ÔºåÂèñÂæóÂÖ®ÈÉ®Ë≥áÊñô
        const script = document.createElement('script');
        script.setAttribute('data-jsonp', 'guestlist');

        // üöÄ Êº∏ÈÄ≤ÂºèËºâÂÖ•ÔºöÂÖàÂòóË©¶Áç≤ÂèñÊõ¥Â§öË≥áÊñôÔºåÂØ¶ÈöõÊî∂Âà∞Â§öÂ∞ëÂ∞±Á∑©Â≠òÂ§öÂ∞ë
        const params = new URLSearchParams({
            callback: 'handleGuestData',
            limit: 999999, // ÂòóË©¶Áç≤ÂèñÂÖ®ÈÉ®ÔºåÂØ¶ÈöõËÉΩÊãøÂ§öÂ∞ëÂ∞±ÊãøÂ§öÂ∞ë
            page: 1,
            _t: Date.now()
        });

        script.src = `${GOOGLE_SCRIPT_READ_URL}?${params.toString()}`;

        // ÈåØË™§ËôïÁêÜ
        script.onerror = function() {
            console.error('JSONP Ë´ãÊ±ÇÂ§±Êïó');
            document.getElementById('guest-table-body').innerHTML = `
                <tr>
                    <td colspan="5" class="table-cell text-center py-8">
                        <span class="material-symbols-outlined text-2xl text-red-500">error</span>
                        <div class="mt-2 text-red-500">Á∂≤Ë∑ØÈÄ£Êé•Â§±Êïó</div>
                        <button onclick="loadGuestData()" class="btn-primary mt-2">
                            <span class="material-symbols-outlined">refresh</span> ÈáçÊñ∞ËºâÂÖ•
                        </button>
                    </td>
                </tr>
            `;
        };

        // Ê∑ªÂä†Âà∞È†ÅÈù¢
        document.head.appendChild(script);

    }

    // Áµ±‰∏ÄÁöÑ UI Êõ¥Êñ∞ÂáΩÊï∏
    function finishDataLoadingAndUpdateUI(finalData) {
        guestData = finalData;

        // ÂàùÂßãÂåñÁØ©ÈÅ∏Ë≥áÊñô
        filteredData = [...guestData];

        // Ë®≠ÁΩÆË≥áÊñôÊõ¥Êñ∞ÊôÇÈñì‰∏¶‰øùÂ≠òËá≥ localStorage
        updateCacheData(guestData);


        // Â¶ÇÊûúÊúâÊêúÂ∞ãÈóúÈçµÂ≠óÔºåÈÄ≤Ë°åÁØ©ÈÅ∏
        if (currentSearchTerm) {
            filterGuests(currentSearchTerm);
        } else {
            // Êõ¥Êñ∞ÂàÜÈ†ÅÈ°ØÁ§∫
            updatePaginationDisplay();
            renderGuestTable();
        }
    }

    // ËºâÂÖ•Ââ©È§òÈ†ÅÈù¢ÁöÑË≥áÊñô
    function loadMorePages(pageNumber, accumulatedData) {
        // Ë®≠ÂÆöÈÄôÂÄãÈ†ÅÈù¢ÁöÑÂõûË™øÂáΩÊï∏
        window[`handleGuestDataPage${pageNumber}`] = function(response) {

            let currentPageData = [];
            if (response.data && Array.isArray(response.data)) {
                currentPageData = response.data;
            } else if (Array.isArray(response)) {
                currentPageData = response;
            }

            // Á¥ØÁ©çË≥áÊñô
            const totalData = [...accumulatedData, ...currentPageData];

            // Ê™¢Êü•ÊòØÂê¶ÈÇÑÊúâ‰∏ã‰∏ÄÈ†Å
            if (response.pagination && response.pagination.hasNextPage) {
                // ÁπºÁ∫åËºâÂÖ•‰∏ã‰∏ÄÈ†Å
                loadMorePages(pageNumber + 1, totalData);
            } else {
                // ÊâÄÊúâÈ†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÔºåÁµ±‰∏ÄÊõ¥Êñ∞ UI
                finishDataLoadingAndUpdateUI(totalData);
            }
        };

        // ÂâµÂª∫Êñ∞ÁöÑ JSONP script
        const script = document.createElement('script');
        script.setAttribute('data-jsonp', `guestlist-page-${pageNumber}`);

        const params = new URLSearchParams({
            callback: `handleGuestDataPage${pageNumber}`,
            page: pageNumber,
            _t: Date.now()
        });

        script.src = `${GOOGLE_SCRIPT_READ_URL}?${params.toString()}`;

        script.onerror = function() {
            console.error(`Á¨¨ ${pageNumber} È†ÅËºâÂÖ•Â§±ÊïóÔºå‰ΩøÁî®Â∑≤ËºâÂÖ•ÁöÑ ${accumulatedData.length} Á≠ÜË≥áÊñô`);
            // ËºâÂÖ•Â§±ÊïóÔºå‰ΩøÁî®Â∑≤ÊúâË≥áÊñôÔºåÁµ±‰∏ÄÊõ¥Êñ∞ UI
            finishDataLoadingAndUpdateUI(accumulatedData);
        };

        document.head.appendChild(script);
    }

    // Êõ¥Êñ∞ÂàÜÈ†ÅÈ°ØÁ§∫ÔºàÂü∫ÊñºÊú¨Âú∞Ë≥áÊñôÔºâ
    function updatePaginationDisplay() {
        updatePaginationInfo();
        updatePaginationButtons();
    }

    // Êõ¥Êñ∞ÂàÜÈ†ÅË≥áË®äÈ°ØÁ§∫
    function updatePaginationInfo() {
        const totalRecords = filteredData.length;
        const start = totalRecords === 0 ? 0 : ((currentPage - 1) * itemsPerPage) + 1;
        const end = Math.min(currentPage * itemsPerPage, totalRecords);

        document.getElementById('pagination-info').textContent =
            `È°ØÁ§∫Á¨¨ ${start}-${end} Á≠ÜÔºåÂÖ± ${totalRecords} Á≠ÜË≥ìÂÆ¢`;
    }

    // Êõ¥Êñ∞ÂàÜÈ†ÅÊåâÈàï
    function updatePaginationButtons() {
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        const pageNumbers = document.getElementById('page-numbers');

        const totalRecords = filteredData.length;
        const totalPages = Math.ceil(totalRecords / itemsPerPage);
        const hasPrevPage = currentPage > 1;
        const hasNextPage = currentPage < totalPages;

        // ‰∏ä‰∏ÄÈ†Å/‰∏ã‰∏ÄÈ†ÅÊåâÈàïÁãÄÊÖã
        prevBtn.disabled = !hasPrevPage;
        nextBtn.disabled = !hasNextPage;

        // ÁîüÊàêÈ†ÅÁ¢ºÊåâÈàï
        pageNumbers.innerHTML = '';

        // Ë®àÁÆóÈ°ØÁ§∫ÁöÑÈ†ÅÁ¢ºÁØÑÂúç
        const maxButtons = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);

        // Ë™øÊï¥Ëµ∑ÂßãÈ†ÅÈù¢
        if (endPage - startPage + 1 < maxButtons) {
            startPage = Math.max(1, endPage - maxButtons + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.className = `px-3 py-2 text-sm font-medium border ${
                i === currentPage
                    ? 'bg-[var(--primary-color)] text-white border-[var(--primary-color)]'
                    : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'
            }`;
            button.onclick = () => goToPage(i);
            pageNumbers.appendChild(button);
        }
    }

    // Ë∑≥ËΩâÂà∞ÊåáÂÆöÈ†ÅÈù¢ÔºàÂâçÁ´ØÂàÜÈ†ÅÔºâ
    function goToPage(page) {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            updatePaginationDisplay();
            renderGuestTable();
        }
    }

    // Ê∏≤ÊüìË≥ìÂÆ¢Ë°®Ê†ºÔºàÊîØÊè¥ÂÆ∂Â∫≠Áæ§ÁµÑÊ©¢ÂúìÂΩ¢È°ØÁ§∫Ôºâ
    function renderGuestTable() {
        const tbody = document.getElementById('guest-table-body');

        if (filteredData.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="table-cell text-center py-8">
                        <span class="material-symbols-outlined text-2xl text-gray-400">person_off</span>
                        <div class="mt-2 text-gray-500">
                            ${currentSearchTerm ? 'Ê≤íÊúâÁ¨¶ÂêàÊêúÂ∞ãÊ¢ù‰ª∂ÁöÑË≥ìÂÆ¢' : 'Â∞öÁÑ°Ë≥ìÂÆ¢Ë≥áÊñô'}
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        // üéØ Âü∫ÊñºÂÆåÊï¥Âø´ÂèñË≥áÊñôÁöÑÂâçÁ´ØÂàÜÈ†Å
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const currentPageData = filteredData.slice(startIndex, endIndex);


        // ÊåâÂÆ∂Â∫≠Áæ§ÁµÑÊï¥ÁêÜË≥áÊñô
        const groupedData = groupGuestsByFamily(currentPageData);

        tbody.innerHTML = groupedData.map(guest => {
            const isCheckedIn = guest.checkedIn;
            const rowClass = isCheckedIn ? 'checked-in-row' : 'unchecked-row';
            const buttonClass = isCheckedIn ? 'btn-primary bg-green-200 text-green-800 hover:bg-green-300' : 'btn-primary';
            const buttonText = isCheckedIn ? '<span class="magic-wand-icon">edit</span> Â∑≤Â†±Âà∞' : '<span class="magic-wand-icon">login</span> Êú™Â†±Âà∞';
            const buttonAction = isCheckedIn ? `viewGuestDetails('${guest.serialNumber}')` : `goToCheckin('${guest.serialNumber}', '${guest.guestName}', ${guest.collectMoney}, ${guest.hasCake})`;

            // Ê∑ªÂä†ÂÆ∂Â∫≠Áæ§ÁµÑÊ®£Âºè
            const familyGroupClass = guest.familyGroupClass || '';
            const familyDisplay = guest.familyId ? `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">${guest.familyId}</span>` : '-';

            return `
                <tr class="transition-colors ${rowClass} ${familyGroupClass}">
                    <td class="table-cell">${guest.serialNumber}</td>
                    <td class="table-cell font-medium">${guest.guestName}</td>
                    <td class="table-cell text-center">${familyDisplay}</td>
                    <td class="table-cell text-center">
                        <input ${guest.collectMoney ? 'checked' : ''}
                               class="checkbox-custom ${isCheckedIn ? 'border-green-300' : ''}"
                               type="checkbox" disabled/>
                    </td>
                    <td class="table-cell text-center">
                        <input ${guest.hasCake ? 'checked' : ''}
                               class="checkbox-custom ${isCheckedIn ? 'border-green-300' : ''}"
                               type="checkbox" disabled/>
                    </td>
                    <td class="table-cell text-right">
                        <button class="${buttonClass}" onclick="${buttonAction}">
                            ${buttonText}
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // üéØ Â•ΩÂìÅÂë≥ÈáçÂØ´ÔºöÁúüÊ≠£Ê∂àÈô§ÁâπÊÆäÊÉÖÊ≥Å
    function groupGuestsByFamily(guests) {
        const result = [];
        const familyMap = new Map();
        
        // ÂàÜÈõ¢ÂÆ∂Â∫≠ÊàêÂì°ÂíåÂÄã‰∫∫Ë≥ìÂÆ¢
        guests.forEach(guest => {
            if (guest.familyId) {
                if (!familyMap.has(guest.familyId)) {
                    familyMap.set(guest.familyId, []);
                }
                familyMap.get(guest.familyId).push(guest);
            } else {
                // ÂÄã‰∫∫Ë≥ìÂÆ¢‰∏çÈúÄË¶Å‰ªª‰ΩïÂÆ∂Â∫≠Ê®ôË®ò
                guest.familyGroupClass = '';
                result.push(guest);
            }
        });

        // Âè™ËôïÁêÜÁúüÊ≠£ÁöÑÂÆ∂Â∫≠Áæ§ÁµÑ
        familyMap.forEach(family => {
            family.forEach((guest, index) => {
                guest.familyGroupClass = calculateFamilyPosition(family.length, index);
                result.push(guest);
            });
        });

        return result;
    }

    // Á¥îÂáΩÊï∏ÔºöÂè™ËôïÁêÜÁúüÂØ¶ÁöÑÂÆ∂Â∫≠‰ΩçÁΩÆ
    function calculateFamilyPosition(familySize, index) {
        if (familySize === 1) return 'family-group-single';
        if (index === 0) return 'family-group-first';
        if (index === familySize - 1) return 'family-group-last';
        return 'family-group-middle';
    }

    // Êü•ÁúãË≥ìÂÆ¢Ë©≥Á¥∞Ë≥áË®ä
    function viewGuestDetails(serialNumber) {
        const guest = guestData.find(g => g.serialNumber === parseInt(serialNumber));
        if (guest) {
            const details = `
Ë≥ìÂÆ¢Á∑®Ëôü: ${guest.serialNumber}
ÂßìÂêç: ${guest.guestName}
Êî∂Á¶ÆÈáë: ${guest.collectMoney ? 'ÊòØ' : 'Âê¶'}
${guest.collectMoney && guest.giftAmount ? `Á¶ÆÈáëÈáëÈ°ç: ${guest.giftAmount}` : ''}
ÊúâÂñúÈ§Ö: ${guest.hasCake ? 'ÊòØ' : 'Âê¶'}
ÁôºÊîæÂñúÈ§Ö: ${guest.cakeGiven ? 'ÊòØ' : 'Âê¶'}
Â†±Âà∞ÊôÇÈñì: ${guest.timestamp ? new Date(guest.timestamp).toLocaleString('zh-TW') : 'Â∞öÊú™Â†±Âà∞'}
            `;
            alert(details);
        }
    }

    // Ë∑≥ËΩâÂà∞Â†±Âà∞Áï´Èù¢
    function goToCheckin(serialNumber, guestName, collectMoney, hasCake) {
        // Âæû guestData ‰∏≠ÊâæÂà∞Ë©≤Ë≥ìÂÆ¢ÁöÑÂÆåÊï¥Ë≥áË®ä
        const guestInfo = guestData.find(guest => guest.serialNumber === parseInt(serialNumber));

        // Èô§ÈåØÁ¢∫Ë™çÔºöÈ°ûÂûãÂïèÈ°åÂ∑≤‰øÆÊ≠£
        console.log('‚úÖ È°ûÂûã‰øÆÊ≠£ÂæåÊü•Ë©¢ÁµêÊûú:', {
            originalSerialNumber: serialNumber,
            serialNumberType: typeof serialNumber,
            parsedSerialNumber: parseInt(serialNumber),
            foundGuestInfo: !!guestInfo,
            guestInfoFamilyId: guestInfo ? guestInfo.familyId : 'Êú™ÊâæÂà∞Ë≥ìÂÆ¢'
        });

        // Âü∫Êú¨ÂèÉÊï∏
        const params = new URLSearchParams({
            sn: serialNumber,
            name: encodeURIComponent(guestName),
            collectMoney: collectMoney,
            hasCake: hasCake
        });

        // Â¶ÇÊûúÊúâÂÆ∂Â∫≠Á∑®ËôüÔºåÂä†ÂÖ•ÂÆ∂Â∫≠ÊàêÂì°Ë≥áË®ä
        if (guestInfo && guestInfo.familyId) {
            // ÊâæÂà∞ÂêåÂÆ∂Â∫≠ÁöÑÊâÄÊúâÊàêÂì°
            const familyMembers = guestData.filter(guest => guest.familyId === guestInfo.familyId);


            if (familyMembers.length > 1) {
                // Â∞áÂÆ∂Â∫≠ÊàêÂì°Ë≥áË®äÁ∑®Á¢ºÁÇ∫ JSON Â≠ó‰∏≤
                const familyData = familyMembers.map(member => ({
                    memberName: member.guestName,
                    isCheckedIn: member.checkedIn
                }));

                params.set('familyId', guestInfo.familyId);
                params.set('familyMembers', encodeURIComponent(JSON.stringify(familyData)));

            } else {
            }
        } else {
        }

        // Ë∑≥ËΩâÂà∞Â†±Âà∞Áï´Èù¢
        window.location.href = `checkin.html?${params.toString()}`;
    }

    // üîÑ Êô∫ËÉΩÂà∑Êñ∞Ë≥áÊñô
    function refreshData(forceReload = false) {
        if (forceReload) {
            document.getElementById('guest-table-body').innerHTML = `
                <tr id="loading-row">
                    <td colspan="5" class="table-cell text-center py-8">
                        <span class="material-symbols-outlined animate-spin text-2xl text-[var(--primary-color)]">refresh</span>
                        <div class="mt-2 text-gray-500">ÈáçÊñ∞ËºâÂÖ•Ë≥áÊñô‰∏≠...</div>
                    </td>
                </tr>
            `;
            loadGuestData();
        } else {
            // ‰ΩøÁî®Êô∫ËÉΩËºâÂÖ•
            smartLoadGuestData();
        }
    }

    // ÊêúÁ¥¢ÂäüËÉΩÔºàÊú¨Âú∞ÊêúÂ∞ã + ÂâçÁ´ØÂàÜÈ†ÅÔºâ
    function filterGuests(searchTerm) {
        currentSearchTerm = searchTerm.trim();

        if (currentSearchTerm === '') {
            // Ê≤íÊúâÊêúÂ∞ãÊ¢ù‰ª∂ÔºåÈ°ØÁ§∫ÂÖ®ÈÉ®Ë≥áÊñô
            filteredData = [...guestData];
        } else {
            // ÊúâÊêúÂ∞ãÊ¢ù‰ª∂ÔºåÈÅéÊøæË≥áÊñô
            const searchLower = currentSearchTerm.toLowerCase();
            filteredData = guestData.filter(guest => {
                const matchesSerial = guest.serialNumber.toString().toLowerCase().includes(searchLower);
                const matchesName = guest.guestName.toString().toLowerCase().includes(searchLower);
                return matchesSerial || matchesName;
            });
        }

        // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ†Å
        currentPage = 1;

        // Êõ¥Êñ∞È°ØÁ§∫
        updatePaginationDisplay();
        renderGuestTable();

        // È°ØÁ§∫/Èö±ËóèÊ∏ÖÈô§ÊåâÈàï
        const clearButton = document.getElementById('clear-search');
        if (currentSearchTerm) {
            clearButton.classList.remove('hidden');
        } else {
            clearButton.classList.add('hidden');
        }
    }

    // Ê∏ÖÈô§ÊêúÁ¥¢
    function clearSearch() {
        const searchInput = document.getElementById('search-input');
        searchInput.value = '';
        filterGuests('');
    }

    // Ê∑ªÂä†Âà∑Êñ∞ÊåâÈàïÂäüËÉΩ
    document.addEventListener('DOMContentLoaded', function() {
        // ÊêúÁ¥¢ÂäüËÉΩ‰∫ã‰ª∂Á∂ÅÂÆö
        const searchInput = document.getElementById('search-input');
        const clearButton = document.getElementById('clear-search');

        // Âç≥ÊôÇÊêúÁ¥¢
        searchInput.addEventListener('input', function(e) {
            filterGuests(e.target.value);
        });

        // Ê∏ÖÈô§ÊêúÁ¥¢
        clearButton.addEventListener('click', clearSearch);

        // Enter ÈçµÊêúÁ¥¢
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                filterGuests(e.target.value);
            }
        });

        // Ê∑ªÂä†Âà∑Êñ∞ÊåâÈàïÂà∞Ê®ôÈ°åÊóÅÈÇä
        const headerDiv = document.querySelector('main .flex.items-center.justify-between');
        const refreshButton = document.createElement('button');
        refreshButton.className = 'btn-primary ml-4';
        refreshButton.innerHTML = '<span class="material-symbols-outlined">refresh</span> Âà∑Êñ∞Ë≥áÊñô';
        refreshButton.onclick = () => refreshData(true); // Âº∑Âà∂ÈáçÊñ∞ËºâÂÖ•

        const addGuestButton = headerDiv.querySelector('button');
        addGuestButton.parentNode.insertBefore(refreshButton, addGuestButton);

        // ÂàÜÈ†ÅÊåâÈàï‰∫ã‰ª∂
        document.getElementById('prev-page').addEventListener('click', function() {
            if (currentPage > 1) {
                goToPage(currentPage - 1);
            }
        });

        document.getElementById('next-page').addEventListener('click', function() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (currentPage < totalPages) {
                goToPage(currentPage + 1);
            }
        });

        // üöÄ Êô∫ËÉΩËºâÂÖ• - Ê™¢Êü•ÊòØÂê¶ÂæûÂ†±Âà∞Áï´Èù¢ÂõûË∑≥
        const urlParams = new URLSearchParams(window.location.search);
        const isLocalUpdate = urlParams.get('localUpdate') === 'true';

        if (isLocalUpdate) {
            // Âæû URL ÂèÉÊï∏Ëß£ÊûêÂ†±Âà∞Ë≥áË®ä
            const checkInData = {
                serialNumber: urlParams.get('sn'),
                guestName: decodeURIComponent(urlParams.get('name') || ''),
                collectMoney: urlParams.get('collectMoney') === 'true',
                giftAmount: parseInt(urlParams.get('giftAmount') || '0'),
                hasCake: urlParams.get('hasCake') === 'true',
                cakeGiven: urlParams.get('cakeGiven') === 'true'
            };


            // ‚úÖ Ê™¢Êü•ÊòØÂê¶ÊúâÁèæÊúâÁ∑©Â≠òË≥áÊñôÔºàÂåÖÊã¨ localStorageÔºâ
            if (guestData.length === 0) {
                loadCacheFromStorage(); // ÂòóË©¶Âæû localStorage ÊÅ¢Âæ©
            }

            if (guestData.length > 0) {

                // Áõ¥Êé•‰ΩøÁî®Á∑©Â≠òÈÄ≤Ë°åÊú¨Âú∞Êõ¥Êñ∞
                const guest = guestData.find(g => g.serialNumber === parseInt(checkInData.serialNumber));
                if (guest) {
                    checkInData.familyId = guest.familyId;
                    updateLocalGuestData(checkInData);
                } else {
                    loadGuestData();
                }
            } else {

                // ËºâÂÖ•Ë≥áÊñôÂæåÂü∑Ë°åÊú¨Âú∞Êõ¥Êñ∞
                const originalCallback = window.handleGuestData;

                window.handleGuestData = function(response) {
                    // Âü∑Ë°åÂéüÂßãÁöÑË≥áÊñôËºâÂÖ•ÈÇèËºØ
                    originalCallback(response);

                    // Â¶ÇÊûúË≥áÊñôËºâÂÖ•ÊàêÂäüÔºåÂü∑Ë°åÊú¨Âú∞Êõ¥Êñ∞
                    if (guestData.length > 0) {
                        // ÊâæÂà∞ÂÆ∂Â∫≠ID‰æÜÊ≠£Á¢∫Êõ¥Êñ∞
                        const guest = guestData.find(g => g.serialNumber === parseInt(checkInData.serialNumber));
                        if (guest) {
                            checkInData.familyId = guest.familyId;
                            updateLocalGuestData(checkInData);
                        }
                    }

                    // ÊÅ¢Âæ©ÂéüÂßãÂõûË™ø
                    window.handleGuestData = originalCallback;
                };

                loadGuestData();
            }

            // Ê∏ÖÁêÜ URL ÂèÉÊï∏
            window.history.replaceState({}, document.title, window.location.pathname);
        } else if (urlParams.has('refresh')) {
            // ËàäÁâàÊú¨Áõ∏ÂÆπÊÄßÔºöÂº∑Âà∂Âà∑Êñ∞
            loadGuestData();
            window.history.replaceState({}, document.title, window.location.pathname);
        } else {
            // Ê≠£Â∏∏Êô∫ËÉΩËºâÂÖ•
            smartLoadGuestData();
        }

        // üïê Èôç‰ΩéËá™ÂãïÂà∑Êñ∞È†ªÁéáÔºöÊØè5ÂàÜÈêòÊô∫ËÉΩÂà∑Êñ∞
        setInterval(() => smartLoadGuestData(true), 5 * 60 * 1000);
    });
</script>

</body></html>